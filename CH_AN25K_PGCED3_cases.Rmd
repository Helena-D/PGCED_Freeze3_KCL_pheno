---
title: "Charlotte's Helix: Data cleaning for the PGC"
author: "Helena Davies"
date: "02/06/2021"
output: html_document
---

# Set up
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Call in library script
```{r source files}
source("./libraries.R")
```

Call in functions script
```{r source files}
source("./functions.R")
```

Retrieve the recent date
```{r Recent date}
date = Sys.Date()
date
```

Read in data
```{r Read in data}
dat_raw <- read_csv("../data_raw/charlottes_helix/CH_+_AN25K_data_merge_04.06.csv")

# Check
colnames(dat_raw)

dat_raw <- dat_raw %>%
  rename(ID = participant_id)
```

```{r Select columns}
dat <- dat_raw %>% 
  select(
    "ID",
    "gender" = "gender_x",
    "Study_x",
    "visit_barcode_x",
    "visit_notes_x",                                                                                                                                                     "visit_barcode_2_x",                                                                                                                                                 "visit_notes_2_x",                                                                                                                                                   "visit_barcode_3_x",                                                                                                                                                 "visit_notes_3_x",                                                                                                                                                   "registration_notes_x",                                                                                                                                              "No Known Diagnosis_x",                                                                                                                                              "Anorexia Nervosa_x",                                                                                                                                                "Bulimia Nervosa_x",                                                                                                                                                 "ED-NOS_x",                                                                                                                                                          "Binge Eating_x",
    "registration_notes.1_x",
    "core_primdiag_x",
    "core_primdiag_date_x",
    "core_secdiag_x",
    "core_bmi_x",
    "registration_notes_y",                                                                                                                                              "No Known Diagnosis_y",                                                                                                                                              "Anorexia Nervosa_y",                                                                                                                                                "Bulimia Nervosa_y",                                                                                                                                                 "ED-NOS_y",                                                                                                                                                          "Binge Eating_y",
    "core_primdiag_y",
    "core_primdiag_date_y",
    "core_secdiag_y",
    "core_bmi_y",
    "current_height_ft" = "How tall are you? - Feet",
    "current_height_inches" = "How tall are you? - Inches", 
    "current_weight_kg"="How much do you weigh now while wearing indoor clothing but no shoes? - Kilograms",      
    "lowest_weight_kg" = "What is the least you have weighed since age 18, not including times when you were physically ill? - Kilograms",
    "highest_weight_kg" ="What is the most you have ever weighed (not counting pregnancy)? - Kilograms",  
    "self_reported_AN" = "Have you ever had Anorexia Nervosa?",
    "self_reported_BN" ="Have you ever had Bulimia Nervosa?",
    "AN_screener" = "Have you had a period of time when you weighed much less than other people you thought you ought to weigh?",
    "possible_ED" = "Has anyone ever been concerned that you might have an eating disorder?",
    "binge_eating" = "Have you ever had eating binges when you ate what most people would regard as an unusually large amount of food in a short period of time?",
    "fasting" = "Which of the following have you ever used to control your shape or weight? - 1. Fast or not eat (for 8 hours or more",
    "diet_pills" = "Which of the following have you ever used to control your shape or weight? - 2. Use diet pills (over the counter or prescription)",
    "excessive_exercise" ="Which of the following have you ever used to control your shape or weight? - 3. Exercise (e.g. feel compelled to exercise, feel uneasy or distressed if unable to exercise)",
    "self_induced_vomiting" = "Which of the following have you ever used to control your shape or weight? - 4. Make yourself vomit",
    "laxatives_diuretics" = "Which of the following have you ever used to control your shape or weight? - 5. Use medications like laxatives or dieuretics",
    "general_self_worth_dependent" = "In general, how dependent has your self-worth been on your body shape or weight? - Please select the appropriate response on the scale",
    "illness_other_than_ED" = "When you weighed much less than other people thought you ought to weigh or were at your lowest weight, was this due to illness other than an eating disorder?",
    "illness" = "What was the illness?",
    "age_at_low_weight" = "How old were you the first time you were at low weight or had anorexia? - Years old",
    "lowest_weight_AN_kg" = "What is the least you weighed when you had periods of low weight or when you had anorexia? - Kilograms",
    "height_at_low_weight_feet" = "How tall were you then? - Feet",
    "height_at_low_weight_inches" = "How tall were you then? - Inches",
    "duration_AN_years"= "How long did you have anorexia for or were at this low weight? - Number of years",
    "duration_AN_months"= "How long did you have anorexia for or were at this low weight? - Number of months",
    "afraid_gaining_weight" = "During the time when you were at your lowest weight, how afraid were you that you might gain weight or become fat?",
    "low_weight_self_worth_dependent" = "During the time when you were at this low weight, how dependent was your self-worth on your body shape or weight? - Please select the appropriate response on the scale.",
    "negative_consequences_health" ="Did you ever think your low weight had negative consequences for your health?",
    "feel_fat" = "During the time when you were at this low weight, did you feel fat?",
    "out_of_control_bingeing" = "When you were having eating binges, did you feel that your eating was out of control?",
    "Q_freq_binge_per_week" =  "When you were binging the most how many binges would you have per week?",
    "NUMBER_freq_binge_per_week" = "Q27b - Number of times per week",
    "DURATION_binge_eating" = "How long did you have binge eating episodes?",
    "age_of_onset_bingeing" = "How old were you when you experienced your first binge episode? - Years old",
    "age_at_last_binge" = "How old were you when you experienced your last binge episode? - Years old",     
    "binge_eating_only_low_weight" = "Did these binge episodes occur only during the period when you were at low weight?",
    "used_laxatives" =  "Earlier you responded that you used laxatives or diuretics to lose weight. Which did you use? (Select each that applies) - Laxatives",
    "used_diuretics"= "Earlier you responded that you used laxatives or diuretics to lose weight. Which did you use? (Select each that applies) - Diuretics",
    "selfinduced_vomiting_at_low weight" = "Which of the following did you use during the period of time that you were at low-weight? (Select all that apply, endorsing these will not lead to more questions about these behaviours.) - Making yourself vomit",
    "laxatives_at_low weight" = "Which of the following did you use during the period of time that you were at low-weight? (Select all that apply, endorsing these will not lead to more questions about these behaviours.) - Laxatives",
    "diuretics_at_low weight" ="Which of the following did you use during the period of time that you were at low-weight? (Select all that apply, endorsing these will not lead to more questions about these behaviours.) - Diuretics",
    "weightlosspills_at_low weight" ="Which of the following did you use during the period of time that you were at low-weight? (Select all that apply, endorsing these will not lead to more questions about these behaviours.) - Weight loss pills",
    "exercise_at_low weight"= "Which of the following did you use during the period of time that you were at low-weight? (Select all that apply, endorsing these will not lead to more questions about these behaviours.) - Excessive exercise (e.g. feeling compelled to exercise, feel uneasy or distressed if unable to exercise)",
    "fasted_at_low weight"="Which of the following did you use during the period of time that you were at low-weight? (Select all that apply, endorsing these will not lead to more questions about these behaviours.) - Fasting (not eating for 8 waking hours or more)",
    "no_weightloss_beh_at_low weight"= "Which of the following did you use during the period of time that you were at low-weight? (Select all that apply, endorsing these will not lead to more questions about these behaviours.) - None of these",
    "selfinduced_vomiting_bingeing" = "Which of the following did you use during the period of time that you were binge eating? (Select all that apply, endorsing these will not lead to more questions about these behaviours.) - Making yourself vomit",
    "laxatives_bingeing" = "Which of the following did you use during the period of time that you were binge eating? (Select all that apply, endorsing these will not lead to more questions about these behaviours.) - Laxatives",
    "diuretics_bingeing" = "Which of the following did you use during the period of time that you were binge eating? (Select all that apply, endorsing these will not lead to more questions about these behaviours.) - Diuretics",
    "weightlosspills_bingeing" ="Which of the following did you use during the period of time that you were binge eating? (Select all that apply, endorsing these will not lead to more questions about these behaviours.) - Weight loss pills",
    "exercise_bingeing"= "Which of the following did you use during the period of time that you were binge eating? (Select all that apply, endorsing these will not lead to more questions about these behaviours.) - Excessive exercise (e.g. feel compelled to exercise, feel uneasy or distressed if unable to exercise)",
    "fasted_bingeing"="Which of the following did you use during the period of time that you were binge eating? (Select all that apply, endorsing these will not lead to more questions about these behaviours.) - Fasting (not eating for 8 waking hours or more)",
    "no_weightloss_bingeing"= "Which of the following did you use during the period of time that you were binge eating? (Select all that apply, endorsing these will not lead to more questions about these behaviours.) - None of these",
    "under_care_medical_practitioner_ED" = "Are you currently under the care of a medical practitioner for an eating disorder?",
    "sought_treatment_eating_beh" = "Have you ever sought treatment for your eating behaviours?",
    "specialised_inpatient_treatment" = "What types of treatment have you ever received for an eating disorder? Please check all that apply - Specialised (eating disorders) inpatient treatment",
    "non_specialised_inpatient_treatment" = "What types of treatment have you ever received for an eating disorder? Please check all that apply - Non-specialised inpatient treatment",
    "residential_treatment" =  "What types of treatment have you ever received for an eating disorder? Please check all that apply - Residential treatment",
    "partial_hospitalisation_day_care" =  "What types of treatment have you ever received for an eating disorder? Please check all that apply - Partial hospitalisation/ Day care treatment",
    "intensive_outpatient_treatment" = "What types of treatment have you ever received for an eating disorder? Please check all that apply - Intensive outpatient treatment",
    "outpatient_treatment" = "What types of treatment have you ever received for an eating disorder? Please check all that apply - Outpatient treatment",
    "primary_care_physician" = "What types of treatment have you ever received for an eating disorder? Please check all that apply - Primary care physician",
    "dietitian" = "What types of treatment have you ever received for an eating disorder? Please check all that apply - Dietitian",
    "no_treatment" = "What types of treatment have you ever received for an eating disorder? Please check all that apply - None",
    "other_treatment" = "Other (please specify)...573")

# Inspect dimensions
dat %>%
  dim()
# Inspect colnames
dat %>%
  colnames()
```

# Identify people with all missing data 
Need to know which people are missing for all relevant data, i.e., data that would otherwise categorise them as case or control
```{r identify people with all missing data}
missing_dat <- dat %>%
  filter(
    is.na(registration_notes_x) & 
    is.na(visit_notes_x) &       
    is.na(visit_notes_2_x) &               
    is.na(visit_notes_3_x) &
    (`No Known Diagnosis_x` == 0 |
      is.na(`No Known Diagnosis_x`)) &
    (`No Known Diagnosis_y` == 0 |
      is.na(`No Known Diagnosis_y`)) &
    (`Anorexia Nervosa_x` == 0 |
      is.na(`Anorexia Nervosa_x`)) &
    (`Anorexia Nervosa_y` == 0 |
      is.na(`Anorexia Nervosa_y`)) &
    (`Bulimia Nervosa_x` == 0 |
      is.na(`Bulimia Nervosa_x`)) &
    (`Bulimia Nervosa_y` == 0 |
      is.na(`Bulimia Nervosa_y`)) &
    (`ED-NOS_x` == 0 |
      is.na(`ED-NOS_x`)) &
    (`ED-NOS_y` == 0 |
      is.na(`ED-NOS_y`)) &
    (`Binge Eating_x` == 0 |
      is.na(`Binge Eating_x`)) &
    (`Binge Eating_y` == 0 |
      is.na(`Binge Eating_y`)) &
    is.na(registration_notes.1_x) &             
    is.na(core_primdiag_x) &                     
    is.na(core_primdiag_date_x) &               
    is.na(core_secdiag_x) &                      
    is.na(core_bmi_x) &                         
    is.na(registration_notes_y) &                
    is.na(core_primdiag_y) &                     
    is.na(core_primdiag_date_y) &               
    is.na(core_secdiag_y) &                      
    is.na(core_bmi_y) &                         
    is.na(current_height_ft) &                   
    is.na(current_height_inches) &              
    is.na(current_weight_kg) &                   
    is.na(lowest_weight_kg) &                   
    is.na(highest_weight_kg) &                   
    is.na(self_reported_AN) &                   
    is.na(self_reported_BN) &                    
    is.na(AN_screener) &                        
    is.na(possible_ED) &                         
    is.na(binge_eating) &                       
    is.na(fasting) &                             
    is.na(diet_pills) &                         
    is.na(excessive_exercise) &                  
    is.na(self_induced_vomiting) &              
    is.na(laxatives_diuretics) &                 
    is.na(general_self_worth_dependent) &       
    is.na(illness_other_than_ED) &               
    is.na(illness) &                            
    is.na(age_at_low_weight) &                   
    is.na(lowest_weight_AN_kg) &                
    is.na(height_at_low_weight_feet) &           
    is.na(height_at_low_weight_inches) &        
    is.na(duration_AN_years) &                   
    is.na(duration_AN_months) &                 
    is.na(afraid_gaining_weight) &               
    is.na(low_weight_self_worth_dependent) &    
    is.na(negative_consequences_health) &        
    is.na(feel_fat) &                           
    is.na(out_of_control_bingeing) &             
    is.na(Q_freq_binge_per_week) &              
    is.na(NUMBER_freq_binge_per_week) &          
    is.na(DURATION_binge_eating) &              
    is.na(age_of_onset_bingeing) &               
    is.na(age_at_last_binge) &                  
    is.na(binge_eating_only_low_weight) &        
    is.na(used_laxatives) &                     
    is.na(used_diuretics) &                      
    is.na(`selfinduced_vomiting_at_low weight`) & 
    is.na(`laxatives_at_low weight`) &             
    is.na(`diuretics_at_low weight`) &            
    is.na(`weightlosspills_at_low weight`) &       
    is.na(`exercise_at_low weight`) &             
    is.na(`fasted_at_low weight`) &                
    is.na(`no_weightloss_beh_at_low weight`) &    
    is.na(selfinduced_vomiting_bingeing) &       
    is.na(laxatives_bingeing) &                 
    is.na(diuretics_bingeing) &                  
    is.na(weightlosspills_bingeing) &           
    is.na(exercise_bingeing) &                   
    is.na(fasted_bingeing) &                    
    is.na(no_weightloss_bingeing) &              
    is.na(under_care_medical_practitioner_ED) & 
    is.na(sought_treatment_eating_beh) &         
    is.na(specialised_inpatient_treatment) &    
    is.na(non_specialised_inpatient_treatment) & 
    is.na(residential_treatment) &              
    is.na(partial_hospitalisation_day_care) &    
    is.na(intensive_outpatient_treatment) &     
    is.na(outpatient_treatment) &                
    is.na(primary_care_physician) &             
    is.na(dietitian) &                           
    is.na(no_treatment) &                       
    is.na(other_treatment)
   )

missing_dat

missing_dat_no_dup <- missing_dat[!duplicated(missing_dat$ID), ]
nrow(missing_dat_no_dup)

# Write data from R to a txt file
write.csv(missing_dat_no_dup,
            file = "missing_dat_IDs.csv")
```

# Narrowly defined binge eating: All individuals who meet any of the following criteria will be coded as “BE_narrow = 1”:

1. Eating an unusually large amount of food in an unusually short period of time with loss of control when doing so, and these episodes occurred on average at least once a week for at least three months (= DSM-5 frequency and duration criteria);
2. Has received a clinical diagnosis of BN or BED via hospital or register records or a structured clinical interview;
        a. If ANBP or OSFED/EDNOS is diagnosed, these individuals will only be included if symptom-level data confirm that they endorse the symptoms as described in item 1 of narrowly defined binge eating);
3. Has a self-reported diagnosis of BN or BED, with specification that this has been confirmed by a healthcare professional;
    a. If ANBP or OSFED/EDNOS is diagnosed, these individuals will only be included if symptom-level confirms that they endorse the symptoms as described in item 1 of
narrowly defined binge eating).

Clean frequency per week binge eating ready for BE_narrow and BE_broad algorithms
```{r Clean freq per week binge eating}
# Check
freq(dat$NUMBER_freq_binge_per_week)

# Convert values written as a range to lowest number
dat$NUMBER_freq_binge_per_week[dat$NUMBER_freq_binge_per_week == "14-21"] <- "14"
dat$NUMBER_freq_binge_per_week[dat$NUMBER_freq_binge_per_week == "15-20"] <- "15"
dat$NUMBER_freq_binge_per_week[dat$NUMBER_freq_binge_per_week == "20-30"] <- "20"
dat$NUMBER_freq_binge_per_week[dat$NUMBER_freq_binge_per_week == "35-45"] <- "35"

# Convert the answer 'daily' to 7 times a week
dat$NUMBER_freq_binge_per_week[dat$NUMBER_freq_binge_per_week == "daily"] <- "7"

# Convert answers that have been converted to dates by an automatic function in Excel to plausible values (taking lower value)
dat$NUMBER_freq_binge_per_week[dat$NUMBER_freq_binge_per_week == "01-Feb"] <- "1"
dat$NUMBER_freq_binge_per_week[dat$NUMBER_freq_binge_per_week == "02-Apr"] <- "2"
dat$NUMBER_freq_binge_per_week[dat$NUMBER_freq_binge_per_week == "02-Mar"] <- "2"
dat$NUMBER_freq_binge_per_week[dat$NUMBER_freq_binge_per_week == "02-Apr"] <- "2"
dat$NUMBER_freq_binge_per_week[dat$NUMBER_freq_binge_per_week == "03-Apr"] <- "3"
dat$NUMBER_freq_binge_per_week[dat$NUMBER_freq_binge_per_week == "05-Jul"] <- "5"
dat$NUMBER_freq_binge_per_week[dat$NUMBER_freq_binge_per_week == "05-Jun"] <- "5"
dat$NUMBER_freq_binge_per_week[dat$NUMBER_freq_binge_per_week == "06-Jul"] <- "6"
dat$NUMBER_freq_binge_per_week[dat$NUMBER_freq_binge_per_week == "07-Oct"] <- "7"
dat$NUMBER_freq_binge_per_week[dat$NUMBER_freq_binge_per_week == "04-May"] <- "4"
dat$NUMBER_freq_binge_per_week[dat$NUMBER_freq_binge_per_week == "Jul-13"] <- "7"

# Check again
freq(dat$NUMBER_freq_binge_per_week)
```

1. Eating an unusually large amount of food in an unusually short period of time with loss of control when doing so, and these episodes occurred on average at least once a week for at least three months (= DSM-5 frequency and duration criteria);
```{r Binge eating with loss of control and DSM-5 duration and frequency}
dat <- dat %>%
  mutate(binge_eating_loss_control_DSM5 =
           case_when(
            
             # "Have you ever had eating binges when you ate what most people would regard as an unusually large amount of food in a short period of time?"
             binge_eating == "Yes" &
               
               # When you were having eating binges, did you feel that your eating was out of control?
             (out_of_control_bingeing == "Yes, definitely out of control" |
                out_of_control_bingeing == "Yes, somewhat out of control" |
                out_of_control_bingeing == "Yes, a little(slightly) out of control") &
               
               # ...these episodes occurred on average at least once a week for at least three months (= DSM-5 frequency and duration criteria);
               (NUMBER_freq_binge_per_week >= 1 &
                  (DURATION_binge_eating == "3-5 months" |
                     DURATION_binge_eating == "6 months to 1 year" |
                     DURATION_binge_eating == "Longer than 1 year")) ~ 1
             )
         )

# Check
dat %>%
  freq(binge_eating_loss_control_DSM5)
```

2. Has received a clinical diagnosis of BN or BED via hospital or register records or a structured clinical interview OR 

“Core_primdiag” = primary diagnosis from clinician.
If no ICD code - Henry could look back and see exactly how they characterised these people BUT this may not be needed if we already have other info on them...

Need to look at responses within each variable
```{r Prim and secondary diagnosis BE_narrow}
# Check
dat %>%
  freq(core_primdiag_y) # 'Bulimia Nervosa'

dat %>%
  freq(core_primdiag_x)  # 'Bulemia Nervosa', 'bulimia nervosa', 'Bulimia Nervosa', 'F50.2 -  Bulimia nervosa'

dat %>%
  freq(core_secdiag_x) # 'bulimia nervosa', 'Bulimia Nervosa'

dat %>%
  freq(core_secdiag_y) # 'Bulimia Nervosa'

# Create single new variable of bulimia nervosa diagnosis
dat <- dat %>%
  mutate(diagnosis_BN =
           case_when(
             core_primdiag_y == "Bulimia Nervosa" |
               core_primdiag_x == "Bulemia Nervosa" |
               core_primdiag_x == "bulimia nervosa" |
               core_primdiag_x == "Bulimia Nervosa" |
               core_primdiag_x == "F50.2 -  Bulimia nervosa" |
               core_secdiag_x == "bulimia nervosa" |
               core_secdiag_x == "Bulimia Nervosa" |
               core_secdiag_y == "Bulimia Nervosa" ~ 1))

# Check
dat %>%
  freq(diagnosis_BN)
```
3. Has a self-reported diagnosis of BN or BED, with specification that this has been confirmed by a healthcare professional

For Charlotte's Helix, the variables 'Bulimia Nervosa_x' and 'Bulimia Nervosa_y': this could include diagnoses but also not diagnosed individuals..
Only knew if it were a clinical diagnosis if came from a clinical sample (e.g., Bethlem) possibly BOA depending on recruitment methods or 100k project, but this is only for AN. For BN/BED, Henry wouldn't count these people.
```{r Text box diagnosis - needs to check if clinical}

dat <- dat %>%
  mutate(text_box_self_reported_BN =
           case_when(`Bulimia Nervosa_x` == 1 |
                      `Bulimia Nervosa_y` == 1 ~ 1
                     )
         )

# Check
dat %>%
  freq(text_box_self_reported_BN) 

```

“reg info” = diagnosis or extra info from sign up (registration_notes_x, registration_notes.1_x, registration_notes_y)
Have looked through all of these and flagged any ICD codes related to BN or BED, or any notes that might confirm a clinical diagnosis by a healthcare professional
```{r Reg info - diagnosis or extra info BE_narrow}
# Reg notes (registration_notes_x, registration_notes.1_x, registration_notes_y) are all the same so only need to look at one. 

dat %>%
  freq(registration_notes.1_x) # "Dx: F50.2 Bulimia Nervosa."

dat <- dat %>%
  mutate(reg_info_BN =
           case_when(registration_notes.1_x == "Dx: F50.2 Bulimia Nervosa."  ~ 1))

# Check
dat %>%
  freq(reg_info_BN)
```

Narrowly defined binge eating
```{r PGC narrowly defined binge eating}
dat <- dat %>%
  mutate(BE_narrow = 
           case_when(reg_info_BN == 1 | # F50.2 Bulimia Nervosa reported in registration notes  
                     #  text_box_self_reported_BN == 1 | # Cannot include these people anymore as unsure if they have a diagnosis
                       diagnosis_BN == 1 | # Primary diagnosis from clinician
                       binge_eating_loss_control_DSM5 == 1 ~ 1 # BE with loss of control and DSM-5 freq and dur criteria
                     )
  )

# Check 
dat %>%
  freq(BE_narrow)
```

# Broadly defined binge eating: All individuals who meet any of the following criteria and will be coded as “BE_broad = 1”:

1. Eating an unusually large amount of food in an unusually short period of time with loss of control when doing so. Frequency and duration criteria are not required.
2. If binge eating (BE) is assessed in a single question like: “Have you ever experienced binge eating?” and is endorsed, they will be considered to have BE and be included in the primary BE GWAS. If the question combines several descriptors such as “Have you ever experienced binge eating OR other terms like psychological overeating, compulsive eating, emotional eating, etc.”), it should not be used for the primary BE GWAS but can be used for PRS
analyses.
3. Has a self-reported diagnosis of BN or BED (specification that this has been confirmed by a healthcare professional is not required for this definition);
    a. If ANBP or OSFED/EDNOS is diagnosed, these individuals will only be included if they explicitly state ‘subthreshold BN’ or ‘subthreshold BED’.
```{r Bingeing with loss of control for BE_broad}

dat <- dat %>%
  mutate(binge_eating_loss_control =
           case_when(
            
             # "Have you ever had eating binges when you ate what most people would regard as an unusually large amount of food in a short period of time?"
             binge_eating == "Yes" &
               
               # When you were having eating binges, did you feel that your eating was out of control?
             (out_of_control_bingeing == "Yes, definitely out of control" |
                out_of_control_bingeing == "Yes, somewhat out of control" |
                out_of_control_bingeing == "Yes, a little(slightly) out of control") ~ 1
             )
         )

# Check
dat %>%
  freq(binge_eating_loss_control)
```

2. If binge eating (BE) is assessed in a single question like: “Have you ever experienced binge eating?” and is endorsed, they will be considered to have BE and be included in the primary BE GWAS. If the question combines several descriptors such as “Have you ever experienced binge eating OR other terms like psychological overeating, compulsive eating, emotional eating, etc.”), it should not be used for the primary BE GWAS but can be used for PRS analyses.
```{r BE assessed in single question BE_broad}
dat %>%
  freq(`Binge Eating_x`) # How was this assessed? Henry doesn't know. (Only 2 people.)

dat %>%
  freq(`Binge Eating_y`)
```

3. Has a self-reported diagnosis of BN or BED (specification that this has been confirmed by a healthcare professional is not required for this definition);
```{r Prim and secondary diagnosis BE_broad}
# Same as for BE_narrow 
dat %>%
  freq(diagnosis_BN)
```

“reg info” = diagnosis or extra info from sign up. If it mentions the word 'diagnosis' or 'dx', then I will include as BE_broad
+++ Need to re-do these! double check spacing

# Diagnosis:    Previous Anorexia and Bulemia, Diagnosis: Bulimia Nervosa, Diagnosis: Bulimia Nervosa  Anorexia (Recovered), Dignosis: Anorexia Nervosa and Bulemia Nervosa 3 years ago, Dx: Anorexia, Bulimia, BPD, Depression, Anxiety, Alcohol misuse; Dx: Binge eating disorder, Dx: Binge Eating Disorder, Dx: Bulimia Nervosa, Dx: F50.2 Bulimia Nervosa. Self reported Diagnosis  Bulimia, Hospitalised for anorexia, ( co-mobid) depression, recently diagnosed with ASD
```{r Reg info - diagnosis or extra info BE_broad}
# Reg notes (registration_notes_x, registration_notes.1_x, registration_notes_y) are all the same so only need to look at one. 
dat %>%
  freq(registration_notes.1_x) 

dat <- dat %>%
  mutate(reg_info_BN_broad =
           case_when( registration_notes.1_x == "Diagnosis:    Previous Anorexia and Bulemia"  |
                      registration_notes.1_x == "Diagnosis: Anorexia as a child, Bulemia and Depression Currently" |
                       registration_notes.1_x == "Diagnosis: Bulimia Nervosa" |
                       registration_notes.1_x == "Diagnosis: Bulimia Nervosa  Anorexia (Recovered)" |
                       registration_notes.1_x == "Dignosis:    Anorexia Nervosa and Bulemia Nervosa 3 years ago" |
                       registration_notes.1_x == "Dx: Anorexia, Bulimia, BPD, Depression, Anxiety, Alcohol misuse" |
                       registration_notes.1_x == "Dx: Binge eating disorder" |
                       registration_notes.1_x == "Dx: Binge Eating Disorder" |
                       registration_notes.1_x == "Dx: Bulimia Nervosa" |
                       registration_notes.1_x == "Dx: F50.2 Bulimia Nervosa." |
                       registration_notes.1_x == "Self reported Diagnosis  Bulimia, Hospitalised for anorexia, ( co-mobid) depression, recently diagnosed with ASD" ~1 ))

# Check
dat %>%
  freq(reg_info_BN_broad)
```

Broadly defined binge eating
```{r PGC broadly defined binge eating}
dat <- dat %>%
  mutate(BE_broad = 
           case_when(BE_narrow == 1 |
                       reg_info_BN_broad == 1 | # Bulimia or BED mentioned with word diagnosis in reg notes  
                       # text_box_self_reported_BN == 1 | # Not necessarily a diagnosis so cannot include
                       diagnosis_BN == 1 | # Prim or secondary diagnosis of BN or BED 
                       binge_eating_loss_control == 1 ~ 1 # Binge eating with loss of control
                     )
  )

# Check 
dat %>%
  freq(BE_broad)
```  

# Anorexia phenotypes
## 1. Visit notes
Identifying AN cases via visit notes
NB: Gerome has said that any mention of anorexia counts as a case. (This does not apply to the binge-type EDs.)
```{r visit notes AN}
# Visit notes 1
dat <- dat %>%
  mutate(visit_notes_AN_1 =
           case_when(
             visit_notes_x == "AN" |
               visit_notes_x == "Case: Anorexia" |
               visit_notes_x == "Case: Anorexia and Body Dysmorphia" |
               visit_notes_x == "Case: Anorexia and Body Dysmorphia" |
               visit_notes_x == "Case: Anorexia as a child, Bulemia and Depression Currently" |
               visit_notes_x == "Case: Anorexia Nervosa" |
               visit_notes_x == "Case: Chronic anorexia Nervosa" |
               visit_notes_x == "Case: History of Anorexia Nervosa" |
               visit_notes_x == "Case: previously anorexia nervosa/ Bulimia" | 
               visit_notes_x == "Recovered AN" ~ 1
           ))

# Visit notes 2
dat <- dat %>%
  mutate(visit_notes_AN_2 =
           case_when(
             visit_notes_2_x == "AN" |
               visit_notes_2_x == "Case: Anorexia Nervosa" |
               visit_notes_2_x == "In CYTAN visit, ppt indicated diagnosis of AN (recovered) and BPD    Researcher taking consent: Olivia Patsalos" |
               visit_notes_2_x == "Participant already gave sample as part of the AN25K Project. No BioResource consent completed for this visit.   AN" |
               visit_notes_2_x == "Recovered AN" |
               visit_notes_2_x == "reconsented 20/10/2015 by AO  Recovered AN" ~ 1
           ))

# Visit notes 3
dat <- dat %>%
  mutate(visit_notes_AN_3 =
           case_when(
             visit_notes_2_x == "AN" |
               visit_notes_2_x == "AN  Samples taken using Oxytocin study consent form  as participant has been BioResourced previously"  ~ 1
           ))

# create single variable for visit notes
dat <- dat %>%
  mutate(visit_notes_AN_final =
           case_when(
             visit_notes_AN_1 == 1 |
               visit_notes_AN_2 == 1 |
               visit_notes_AN_3 == 1 ~ 1
             
           ))

# Check
dat %>%
  freq(visit_notes_AN_final)
```
## 2. Algorithm-derived

### Work out BMI at low weight
```{r BMI at low weight}
# Convert height in ft and inches to metres 
dat$height_m_1 <- dat$height_at_low_weight_feet/3.281

dat$height_m_2 <- as.numeric(dat$height_at_low_weight_inches)/39.37

dat$height_m_low_weight <- dat$height_m_1 + dat$height_m_2

# Check
freq(dat$height_m_low_weight)

# Work out BMI
dat$AN_BMI <- as.numeric(dat$lowest_weight_AN_kg) / as.numeric(dat$height_m_low_weight)^2

# Check
head(dat$lowest_weight_AN_kg)
head(dat$height_m_low_weight)
head(dat$AN_BMI)

# Look at min and max
descr(dat$AN_BMI) # All values between 8 and 38 so are all plausible.
```
  
### ANBP algorithm
A. Restriction of energy intake relative to requirements,leading to a significantly low body weight in the context of age, sex, developmental trajectory, and physical health. Significantly low weight is defined as a weight that is less than minimally normal or, for children and adolescents, less than that minimally expected.

B. Intense fear of gaining weight or of becoming fat, or persistent behavior that interferes with weight gain, even though at a significantly low weight.

C. Disturbance in the way in which one’s body weight or shape is experienced, undueinfluence of body weight or shape on self-evaluation, or persistent lack of recognition of the seriousness of the current low body weight.

Subtype of DSM-5 AN; All DSM5 AN symptoms are met, but...

Binge eating/purging subtype: During the last 3 months, the individual has engaged in recurrent episodes of binge-eating or purging behavior (i.e., self-induced vomiting or the misuse of laxatives, diuretics, or enemas).
```{r ANBP algorithm}
dat$DSM5_AN_binge_purge_binary_numeric <- 
  with(dat,
  dplyr::if_else(
# A. Restriction of energy intake relative to requirements,leading to a significantly low body weight in the context of age, sex, developmental trajectory, and physical health. Significantly low weight is defined as a weight that is less than minimally normal or, for children and adolescents, less than that minimally expected.
     (
       (
     AN_BMI <= 18.5  # Lowest BMI as reported in ED100K questionnaire
      ) &
 
# B. Intense fear of gaining weight or of becoming fat, or persistent behavior that interferes with weight gain, even though at a significantly low weight.
   
  (
      afraid_gaining_weight == "Somewhat" | 
      afraid_gaining_weight == "Very Much"
      ) &

# C. Disturbance in the way in which one’s body weight or shape is experienced... 
(
  (
     feel_fat == "Very much" | 
     feel_fat == "Somewhat" 
    ) |
    
#...undue influence of body weight or shape on self-evaluation
 
   # During the time when you were at this low weight, how dependent was your self-worth on your body shape or weight?
    (
      low_weight_self_worth_dependent== "3" | # Scale from 0-7 (the first three options are not counted, i.e., 0-2)
      low_weight_self_worth_dependent == "4" |
      low_weight_self_worth_dependent == "5" |
      low_weight_self_worth_dependent == "6" |
      low_weight_self_worth_dependent == "7"
  ) |

#...OR persistent lack of recognition of the seriousness of the current low body weight.
  
  # Did you ever think your low weight had negative consequences for your health?
     negative_consequences_health == "Not at all"
) &

   # Binge eating/purging subtype: During the last 3 months... 
  
 #...the individual has engaged in recurrent episodes of binge-eating whilst at low weight.. 
    (
      binge_eating_only_low_weight == "Yes" | # NB: The only options are "yes" or "no" - therefore may have missed people who binged BOTH at low and higher weight
      
      #...OR purging behavior (i.e., self-induced vomiting or the misuse of laxatives, diuretics, or enemas).
  (
      `selfinduced_vomiting_at_low weight` == "Making yourself vomit" |
      `laxatives_at_low weight` == "Laxatives" |
      `diuretics_at_low weight` == "Diuretics"
    )
  )
),
# Not included absence of fasting and/or exercise because ANBP captures people who are restricting but ALSO binge and/or purge (on top of restricting behaviour)
    true = 1,
    false = 0,
    missing = NA_real_)
)
  
# Recode numeric to factor
dat$DSM5_ANBP_binary <-
  recode_factor(dat$DSM5_AN_binge_purge_binary_numeric,
                "0" = "No DSM5 AN binge eating/purging",
                "1" = "DSM5 AN binge eating/purging")


# Summary
freq(dat$DSM5_ANBP_binary)
```

### AN restricting algorithm 
A. Restriction of energy intake relative to requirements,leading to a significantly low body weight in the context of age, sex, developmental trajectory, and physical health. Significantly low weight is defined as a weight that is less than minimally normal or, for children and adolescents, less than that minimally expected.

B. Intense fear of gaining weight or of becoming fat, or persistent behavior that interferes with weight gain, even though at a significantly low weight.

C. Disturbance in the way in which one’s body weight or shape is experienced, undueinfluence of body weight or shape on self-evaluation, or persistent lack of recognition of the seriousness of the current low body weight.

Subtype of DSM-5 AN; All DSM5 AN symptoms are met, but...

The individual has not engaged in recurrent episodes of binge eating or purging behavior (i.e., self-induced vomiting or the misuse of laxatives, diuretics, or enemas).This subtype describes presentations in which weight loss is accomplished primarily through dieting, fasting, and/or excessive exercise.
```{r ANR algorithm}
dat$DSM5_AN_restricting_binary_numeric <- 
  with(dat,
  dplyr::if_else(
#A. Restriction of energy intake relative to requirements,leading to a significantly low body weight in the context of age, sex, developmental trajectory, and physical health. Significantly low weight is defined as a weight that is less than minimally normal or, for children and adolescents, less than that minimally expected.
     (
       (
     AN_BMI <= 20  # Lowest BMI as reported in ED100K questionnaire (raised to 20 as discussed within the pheno committee)
      ) &
 
#B. Intense fear of gaining weight or of becoming fat, or persistent behavior that interferes with weight gain, even though at a significantly low weight.
   
  (
      afraid_gaining_weight == "Somewhat" | 
      afraid_gaining_weight == "Very Much"
      ) &

#C. Disturbance in the way in which one’s body weight or shape is experienced... 
(
  (
     feel_fat == "Very much" | 
     feel_fat == "Somewhat" 
    ) |
    
#...undue influence of body weight or shape on self-evaluation
 
    ( low_weight_self_worth_dependent== "3" | # Scale from 0-7 
      low_weight_self_worth_dependent == "4" |
      low_weight_self_worth_dependent == "5" |
      low_weight_self_worth_dependent == "6" |
      low_weight_self_worth_dependent == "7"
  ) |

#...OR persistent lack of recognition of the seriousness of the current low body weight.
  
     negative_consequences_health == "Not at all"
) &

   # Restricting type: During the last 3 months... 
  
  #...the individual has not engaged in recurrent episodes of binge eating... 
  (
   (binge_eating == "No" | # Not ever binged
    binge_eating_only_low_weight == "No")  & # Binged but not at low weight
     
     #...or purging behavior (i.e., self-induced vomiting or the misuse of laxatives, diuretics, or enemas)...  
      
        # NB: Participants appear to either be, for example for `selfinduced_vomiting_at_low weight`, "Making yourself vomit" or NA. Wouldn't normally assume that a value of missing is indicative of a lack of endorsement, but in this case (for the purging behaviours at low weight) there doesn't seem to be another option. 
     (
       (self_induced_vomiting == "Never" |  # Never self-induced vomiting
     is.na(`selfinduced_vomiting_at_low weight`))  & #...has but not indicated to have done this at low weight
       
      
    (laxatives_diuretics == "Never" | # Never used laxatives or diuretics
      (is.na(`laxatives_at_low weight`) & #...has but not indicated to have done this at low weight
       is.na(`diuretics_at_low weight`))) #...has but not indicated to have done this at low weight
      ) &
     # Does not meet criteria for ANBP
   (DSM5_AN_binge_purge_binary_numeric == 0 |
     is.na(DSM5_AN_binge_purge_binary_numeric))
     ) 
  ),
    true = 1,
    false = 0,
    missing = NA_real_
)
)
  
# Recode numeric to factor
dat$DSM5_ANR_binary <-
  recode_factor(dat$DSM5_AN_restricting_binary_numeric,
                "0" = "No DSM5 AN restricting",
                "1" = "DSM5 AN restricting")


 # Summary
freq(dat$DSM5_ANR_binary)

# Sanity check
dat %>%
  filter(DSM5_AN_binge_purge_binary_numeric == 1 &
          DSM5_AN_restricting_binary_numeric == 1 ) # checking this is 0 as it should be!
```

### AN no subtype algorithm 
A. Restriction of energy intake relative to requirements,leading to a significantly low body weight in the context of age, sex, developmental trajectory, and physical health. Significantly low weight is defined as a weight that is less than minimally normal or, for children and adolescents, less than that minimally expected.

B. Intense fear of gaining weight or of becoming fat, or persistent behavior that interferes with weight gain, even though at a significantly low weight.

C. Disturbance in the way in which one’s body weight or shape is experienced, undueinfluence of body weight or shape on self-evaluation, or persistent lack of recognition of the seriousness of the current low body weight.
```{r AN no subtype algorithm}
dat$DSM5_AN_binary_numeric <- 
  with(dat,
  dplyr::if_else(
#A. Restriction of energy intake relative to requirements,leading to a significantly low body weight in the context of age, sex, developmental trajectory, and physical health. Significantly low weight is defined as a weight that is less than minimally normal or, for children and adolescents, less than that minimally expected.
     (
       (
     AN_BMI <= 18.5  #Lowest BMI as reported in ED100K optional questionnaire 
      ) &
 
#B. Intense fear of gaining weight or of becoming fat, or persistent behavior that interferes with weight gain, even though at a significantly low weight.
   
  (
      afraid_gaining_weight == "Somewhat" | 
      afraid_gaining_weight == "Very Much"
      ) &

#C. Disturbance in the way in which one’s body weight or shape is experienced... 
(
  (
     feel_fat == "Very much" | 
     feel_fat == "Somewhat" 
    ) |
    
#...undue influence of body weight or shape on self-evaluation
 
    (
      low_weight_self_worth_dependent== "3" | # Scale from 0-7
      low_weight_self_worth_dependent == "4" |
      low_weight_self_worth_dependent == "5" |
      low_weight_self_worth_dependent == "6" |
      low_weight_self_worth_dependent == "7"
  ) |

#...OR persistent lack of recognition of the seriousness of the current low body weight.
  
     negative_consequences_health == "Not at all"
  )
),
    true = 1,
    false = 0,
    missing = NA_real_)
)
  
#Recode numeric to factor
dat$DSM5_AN_binary <-
  recode_factor(dat$DSM5_AN_binary_numeric,
                "0" = "No DSM5 AN no subtype",
                "1" = "DSM5 AN no subtype")


# Summary
freq(dat$DSM5_AN_binary)
```
## 3. Self-reported AN, but not necessarily a diagnosis. 
NB: However, Gerome has said that all AN cases within Charlotte's Helix can be thought of as self-reported clinical diagnoses.
```{r Text box self-reported AN}

dat <- dat %>%
  mutate(text_box_self_reported_AN =
           case_when(`Anorexia Nervosa_x` == 1 |
                       `Anorexia Nervosa_y` == 1 ~ 1)
         )

# Check
dat %>%
  freq(text_box_self_reported_AN)
```

## 4. AN registration notes
Diagnosis of AN mentioned in registration notes
Update 29.7.21: Any mention of AN can be thought of as self-reported clinical diagnoses
```{r Diagnosis of AN reg notes}
dat %>%
  freq(registration_notes.1_x)  

dat <- dat %>%
  mutate(AN_registration =
           case_when(
           registration_notes.1_x == "Anorexia Diagnosed in Jan 2012" |
           registration_notes.1_x == "Diagnosed May 2013  Anorexia Nervosa" |
           registration_notes.1_x == "Diagnosed with Anorexia August 2012" |
           registration_notes.1_x == "Diagnosis    Anorexia Nervosa" |
           registration_notes.1_x == "Diagnosis   Anorexia Nervosa" |
           registration_notes.1_x == "Diagnosis  Anorexia" |
           registration_notes.1_x == "Diagnosis  Anorexia Nervosa" |
           registration_notes.1_x == "Anorexia Nervosa, Autistic Spectrum with features of Aspergers and ADHD" |
           registration_notes.1_x == "Diagnosis:    Previous Anorexia and Bulemia" |
           registration_notes.1_x == "Diagnosis: Anorexia and borderline personality disorder" |
           registration_notes.1_x == "Diagnosis: Anorexia and borderline personality disorder  Currently on ward - Tysen West 2 at Bethlem." |
           registration_notes.1_x == "Diagnosis: Anorexia as a child, Bulemia and Depression Currently" |
           registration_notes.1_x == "Diagnosis: Anorexia nervosa" |
           registration_notes.1_x == "Diagnosis: Anorexia Nervosa" |
           registration_notes.1_x == "Diagnosis: Anorexia Nervosa." |
           registration_notes.1_x == "Diagnosis: Bulimia Nervosa  Anorexia (Recovered)" |
           registration_notes.1_x == "Dignosis:    Anorexia Nervosa and Bulemia Nervosa 3 years ago" |
           registration_notes.1_x == "Dignosis:    Anorexia Nervosa F50.0  Chronic Depression  OCD  Stroke with lasting physical effects" |
           registration_notes.1_x == "Dx: AN 4 years - recently discharged from clinical psychology care and in beginning stage of recovery" |
           registration_notes.1_x == "Dx: Anorexia; Dx: anorexia and depression" |
           registration_notes.1_x == "Dx: Anorexia Nervosa" |
           registration_notes.1_x == "Dx: Anorexia Nervosa - treated at the Royal Free Hospital as full time outpatient from May 1999-June 2000." |
           registration_notes.1_x == "Dx: Anorexia Nervosa (current) and Clinical Depression (past episode).  Suspected Pure-O (OCD) but not formally diagnosed." |
           registration_notes.1_x == "Dx: Anorexia, Bulimia, BPD, Depression, Anxiety, Alcohol misuse" |
           registration_notes.1_x == "Dx: Anorexia, depression" |
           registration_notes.1_x == "Dx: Anorexia, Depression" |
           registration_notes.1_x == "Dx: anorexia, depression, ASD" |
           registration_notes.1_x == "Dx: Anoroexia, OCD, Depression" |
           registration_notes.1_x == "Dx: depression and recovered anorexic" |
           registration_notes.1_x == "Dx: depression, anorexia, anxiety" |
           registration_notes.1_x == "Dx: EDNOS, anorexia, anxiety, depression" |
           registration_notes.1_x == "Dx: F50.0 Anorexia Nervosa" |
           registration_notes.1_x == "Dx: F50.0 Anorexia Nervosa." |
           registration_notes.1_x == "Dx: history of anorexia nervosa, currently prescribed sertraline fpr mixed anxiety and depression, and fludrocortisone for POTS" |
           registration_notes.1_x == "Dx: Personality Disorder, depression, Anorexia Nervosa (remission)" |
           registration_notes.1_x == "F50.0 Anoreaxia Nervosa" |
           registration_notes.1_x == "Primary Diagnosis:    Anorexia Nervosa    Secondary Diagnosis:    Complex PTSD, Functional Neurological Disorder, M.E, Ehlers Danlos Syndrome" |
           registration_notes.1_x == "Self reported Diagnosis  Bulimia, Hospitalised for anorexia, ( co-mobid) depression, recently diagnosed with ASD"  |
           registration_notes.1_x == "Dx: Anorexia now ENDOS" |
           
             # Updates 29.7.21; have added any mention of AN, regardless of whether a diagnosis is mentioned.
           registration_notes.1_x == "AN, Depression, BN" |
           registration_notes.1_x == "AN/BN/EDNOS " |                                                
           registration_notes.1_x == "Anorexia" |
           registration_notes.1_x == "Anorexia (Recovered)" |      
           registration_notes.1_x == "Anorexia 2008-Present, Chronic Fatigue June14-Present, IBS -Present" |                                                                                                        
           registration_notes.1_x == "Anorexia and Depression" |
           registration_notes.1_x == "Anorexia and Mood Disorder" |
           registration_notes.1_x == "Anorexia Nervosa" |
           registration_notes.1_x == "Anorexia, Anxiety, Depression    Participant  emailed 03052018 to explain they are no longer suffering from depression and no longer taking antidepressant medications" |
           registration_notes.1_x == "Anorexia, Autistic Spectrum Disorder, Depression" |
           registration_notes.1_x == "Anorexia, depression" |
           registration_notes.1_x == "Anorexia, Epilepsy" |
           registration_notes.1_x == "Anorexia, osteoperosis, hypertrophic cardiomyopathy" |
           registration_notes.1_x == "Aspergers + AN" |
           registration_notes.1_x == "Currently: depression, anxiety, EDNOS  Previously: anorexia and bulimia" |
           registration_notes.1_x == "F50.0 Anoreaxia Nervosa" |
           registration_notes.1_x == "Anorexia, Anxiety, Depression" |
           registration_notes.1_x == "Previously anorexia - bulimia currently in treatment" |
           registration_notes.1_x == "Recovered from AN for 2 years, suffered for 4 years. An caused Hypopituitarism and Secondary Addisons disease." |
           registration_notes.1_x == "Recovered from Anorexia Nervosa and depression" | 
           registration_notes.1_x == "Self reported Diagnosis  Bulimia, Hospitalised for anorexia, ( co-mobid) depression, recently diagnosed with ASD" ~ 1))


# Check
dat %>%
  freq(AN_registration)
```

## 5. AN reported in primary diagnosis or secondary diagnosis
```{r Core primary and secondary diagnosis AN}
# Check
dat %>%
  freq(core_primdiag_y) # 'Anorexia Nervosa'; 'F50.0 Anorexia Nervosa'

dat %>%
  freq(core_primdiag_x) # 'Anorexia'; 'anorexia nervosa'; 'Anorexia Nervosa'; 'F50.0 -  Anorexia nervosa'; 'F50.0 Anorexia Nervosa'; 'F50.1 -  Atypical anorexia nervosa'; 'ICD-10 F50.0 - Anorexia nervosa'

dat %>%
  freq(core_secdiag_x) # 'anorexia nervosa'; 'Anorexia Nervosa'; 'F50.0 Anorexia Nervosa'; 'F50.0 Anorexia Nervosa'; 'ICD-10 F50.0 - Anorexia nervosa'

dat %>%
  freq(core_secdiag_y) # 'Anorexia Nervosa'; 'F50.0 Anorexia Nervosa'

dat <- dat %>%
  mutate(prim_second_diag_AN = 
           case_when(core_primdiag_y == "Anorexia Nervosa" |
                      core_primdiag_y ==   "F50.0 Anorexia Nervosa" |
                      core_primdiag_x == "Anorexia" |
                      core_primdiag_x ==  "anorexia nervosa" |
                      core_primdiag_x ==  "Anorexia Nervosa" |
                      core_primdiag_x ==  "F50.0 -  Anorexia nervosa" |
                      core_primdiag_x ==  "F50.0 Anorexia Nervosa" |
                      core_primdiag_x ==  "F50.1 -  Atypical anorexia nervosa" |
                      core_primdiag_x ==  "ICD-10 F50.0 - Anorexia nervosa" |
                      core_secdiag_x == "anorexia nervosa" |
                      core_secdiag_x == "Anorexia Nervosa" |
                      core_secdiag_x == "F50.0 Anorexia Nervosa" |
                      core_secdiag_x == "F50.0 Anorexia Nervosa" |
                      core_secdiag_x == "ICD-10 F50.0 - Anorexia nervosa" |
                      core_secdiag_y == " Anorexia Nervosa" |
                      core_secdiag_y == "F50.0 Anorexia Nervosa" 
                    ~ 1
                    )
         )

# Check 
dat %>%
  freq(prim_second_diag_AN)
```

ANBP in registration
```{r ANBP in registration}
dat <- dat %>%
  mutate(ANBP_registration =
           case_when(
           registration_notes.1_x == "Diagnosis:    Anorexia, Binge Purge type  Bulemia   EDNOC" |
           registration_notes.1_x == "Anorexia and Binges"  ~ 1))

# Check
dat %>%
  freq(ANBP_registration)
```

ANR in registration
```{r ANBP in registration}
dat <- dat %>%
  mutate(ANR_registration =
           case_when(
           registration_notes.1_x == "Diagnosis  Anorexia Nervosa restrictive subtype and depression and anxiety" |
           registration_notes.1_x == "Diagnosis: anorexia nervosa(restrictive type)" |
           registration_notes.1_x ==  "Dx: anorexia nervosa (restrictive subtype), CFS" ~ 1))


# Check
dat %>%
  freq(ANR_registration)
```
## 6. Receruitment into 100,000 Genomes Project 
These people were recruited based on having severe and enduring AN with a BMI of below 16. We can assume that they have a diagnosis of AN.
```{r 100,000 genome project}
 dat <- dat %>%
  mutate(AN_100K =
           case_when(  visit_barcode_x == "BED00567" |
                       visit_barcode_x == "BED01089" |
                       visit_barcode_x == "BED00214" |
                       visit_barcode_x == "BED00504" |
                       visit_barcode_x == "BED00181" |
                       visit_barcode_x == "BED00338" |
                       visit_barcode_x == "BED00229" |
                       visit_barcode_x == "BED00400" |
                       visit_barcode_x == "BED00476" |
                       visit_barcode_x == "BED00166" |
                       visit_barcode_x == "BED00351" |
                       visit_barcode_x == "BED00381" |
                       visit_barcode_x == "BED00374" |
                       visit_barcode_x == "BED00481" |
                       visit_barcode_x == "BED00485" |
                       visit_barcode_x == "BED00376" |
                       visit_barcode_x == "BED00535" |
                       visit_barcode_x == "BED00584" |
                       visit_barcode_x == "BED00182" |
                       visit_barcode_x == "BED00198" |
                       visit_barcode_x == "BED00360" |
                       visit_barcode_x == "BED00655" |
                       visit_barcode_x == "BED00512" |
                       visit_barcode_x == "BED00171" |
                       visit_barcode_x == "BED00564" |
                       visit_barcode_x == "BED00538" |
                       visit_barcode_x == "BED00377" |
                       visit_barcode_x == "BED00269" |
                       visit_barcode_x == "BED00548" |
                       visit_barcode_x == "BED00565" |
                       visit_barcode_x == "BED00753" |
                       visit_barcode_x == "BED00542" |
                       visit_barcode_x == "BED00501 / CYT10018" |
                       visit_barcode_x == "BED00036" |
                       visit_barcode_x == "BED00300" |
                       visit_barcode_x == "BED00203" |
                       visit_barcode_x == "BED00215" |
                       visit_barcode_x == "BED00370" |
                       visit_barcode_x == "BED00219" |
                       visit_barcode_x == "BED00552" |
                       visit_barcode_x == "BED00679" |
                       visit_barcode_x == "BED00737" |
                       visit_barcode_x == "TIR0017B" |
                       visit_barcode_x == "BED00366" |
                       visit_barcode_x == "BED00251" |
                       visit_barcode_x == "BED01017" |
                       visit_barcode_x == "BED00988" |
                       visit_barcode_x == "BED00990 / CYT10039" |
                         
                       visit_barcode_2_x == "BED00567" |
                       visit_barcode_2_x == "BED01089" |
                       visit_barcode_2_x == "BED00214" |
                       visit_barcode_2_x == "BED00504" |
                       visit_barcode_2_x == "BED00181" |
                       visit_barcode_2_x == "BED00338" |
                       visit_barcode_2_x == "BED00229" |
                       visit_barcode_2_x == "BED00400" |
                       visit_barcode_2_x == "BED00476" |
                       visit_barcode_2_x == "BED00166" |
                       visit_barcode_2_x == "BED00351" |
                       visit_barcode_2_x == "BED00381" |
                       visit_barcode_2_x == "BED00374" |
                       visit_barcode_2_x == "BED00481" |
                       visit_barcode_2_x == "BED00485" |
                       visit_barcode_2_x == "BED00376" |
                       visit_barcode_2_x == "BED00535" |
                       visit_barcode_2_x == "BED00584" |
                       visit_barcode_2_x == "BED00182" |
                       visit_barcode_2_x == "BED00198" |
                       visit_barcode_2_x == "BED00360" |
                       visit_barcode_2_x == "BED00655" |
                       visit_barcode_2_x == "BED00512" |
                       visit_barcode_2_x == "BED00171" |
                       visit_barcode_2_x == "BED00564" |
                       visit_barcode_2_x == "BED00538" |
                       visit_barcode_2_x == "BED00377" |
                       visit_barcode_2_x == "BED00269" |
                       visit_barcode_2_x == "BED00548" |
                       visit_barcode_2_x == "BED00565" |
                       visit_barcode_2_x == "BED00753" |
                       visit_barcode_2_x == "BED00542" |
                       visit_barcode_2_x == "BED00501 / CYT10018" |
                       visit_barcode_2_x == "BED00036" |
                       visit_barcode_2_x == "BED00300" |
                       visit_barcode_2_x == "BED00203" |
                       visit_barcode_2_x == "BED00215" |
                       visit_barcode_2_x == "BED00370" |
                       visit_barcode_2_x == "BED00219" |
                       visit_barcode_2_x == "BED00552" |
                       visit_barcode_2_x == "BED00679" |
                       visit_barcode_2_x == "BED00737" |
                       visit_barcode_2_x == "TIR0017B" |
                       visit_barcode_2_x == "BED00366" |
                       visit_barcode_2_x == "BED00251" |
                       visit_barcode_2_x == "BED01017" |
                       visit_barcode_2_x == "BED00988" |
                       visit_barcode_2_x == "BED00990 / CYT10039" |
                         
                       visit_barcode_3_x == "BED00567" |
                       visit_barcode_3_x == "BED01089" |
                       visit_barcode_3_x == "BED00214" |
                       visit_barcode_3_x == "BED00504" |
                       visit_barcode_3_x == "BED00181" |
                       visit_barcode_3_x == "BED00338" |
                       visit_barcode_3_x == "BED00229" |
                       visit_barcode_3_x == "BED00400" |
                       visit_barcode_3_x == "BED00476" |
                       visit_barcode_3_x == "BED00166" |
                       visit_barcode_3_x == "BED00351" |
                       visit_barcode_3_x == "BED00381" |
                       visit_barcode_3_x == "BED00374" |
                       visit_barcode_3_x == "BED00481" |
                       visit_barcode_3_x == "BED00485" |
                       visit_barcode_3_x == "BED00376" |
                       visit_barcode_3_x == "BED00535" |
                       visit_barcode_3_x == "BED00584" |
                       visit_barcode_3_x == "BED00182" |
                       visit_barcode_3_x == "BED00198" |
                       visit_barcode_3_x == "BED00360" |
                       visit_barcode_3_x == "BED00655" |
                       visit_barcode_3_x == "BED00512" |
                       visit_barcode_3_x == "BED00171" |
                       visit_barcode_3_x == "BED00564" |
                       visit_barcode_3_x == "BED00538" |
                       visit_barcode_3_x == "BED00377" |
                       visit_barcode_3_x == "BED00269" |
                       visit_barcode_3_x == "BED00548" |
                       visit_barcode_3_x == "BED00565" |
                       visit_barcode_3_x == "BED00753" |
                       visit_barcode_3_x == "BED00542" |
                       visit_barcode_3_x == "BED00501 / CYT10018" |
                       visit_barcode_3_x == "BED00036" |
                       visit_barcode_3_x == "BED00300" |
                       visit_barcode_3_x == "BED00203" |
                       visit_barcode_3_x == "BED00215" |
                       visit_barcode_3_x == "BED00370" |
                       visit_barcode_3_x == "BED00219" |
                       visit_barcode_3_x == "BED00552" |
                       visit_barcode_3_x == "BED00679" |
                       visit_barcode_3_x == "BED00737" |
                       visit_barcode_3_x == "TIR0017B" |
                       visit_barcode_3_x == "BED00366" |
                       visit_barcode_3_x == "BED00251" |
                       visit_barcode_3_x == "BED01017" |
                       visit_barcode_3_x == "BED00988" |
                       visit_barcode_3_x == "BED00990 / CYT10039" ~ 1
                       )
         )

dat %>%
  freq(AN_100K)
```

## 7. BOA sample is also a clinical anorexia sample
```{r BOA sample}
dat <- dat %>%
  mutate(BOA_AN =
           case_when(
             str_detect(visit_barcode_3_x, "BOA") ~ 1, 
             str_detect(visit_barcode_2_x, "BOA") ~ 1,
             str_detect(visit_barcode_x, "BOA") ~ 1
             )
  )

# Check
dat %>%
  freq(BOA_AN)
```

# PGC AN final algorithms
## PGC AN (no subtype) algorithm
```{r PGC AN algorithm}
dat <- dat %>%
  mutate(AN_case =
           case_when(prim_second_diag_AN == 1 |
                       AN_registration == 1 | # Now includes any mention of AN
                       text_box_self_reported_AN == 1 | # Can now include
                       DSM5_AN_binary_numeric == 1 | # This will include people who meet diagnostic criteria for ANR or ANBP, but have included below for completeness
                       DSM5_AN_restricting_binary_numeric == 1 |
                       DSM5_AN_binge_purge_binary_numeric == 1 |
                       visit_notes_AN_final == 1 |
                       AN_100K == 1 |
                       BOA_AN == 1 |
                       ANR_registration == 1 |
                       ANBP_registration == 1 ~ 1 
                     )
         )

# Check
dat %>%
  freq(AN_case)
```

PGC ANR algorithm
```{r PGC ANR algorithm}
dat <- dat %>%
  mutate(ANR_case =
           case_when(DSM5_AN_restricting_binary_numeric == 1 |
                      ANR_registration == 1 & 
                       (ANBP_registration != 1 &
                        DSM5_AN_binge_purge_binary_numeric != 1)  ~ 1
                     )
         )

# Check
dat %>%
  freq(ANR_case)
```
  
PGC ANBP algorithm
```{r PGC ANBP algorithm}
dat <- dat %>%
  mutate(ANBP_case =
           case_when(DSM5_AN_binge_purge_binary_numeric == 1 |
                      ANBP_registration == 1 ~1
                     )
         )

# Check
dat %>%
  freq(ANBP_case)
```

# Need these additional variables:
• Age (i.e., when assessed); **NA**
• Age at onset;
• Sex (biological sex at birth); **NA** ONLY GENDER (can use genetic data though?)
• Cases: Minimum lifetime eating disorder-related body mass index (BMI);
• Controls: Minimum adult BMI; **NA** no controls
• Maximum lifetime BMI; 
• Current BMI (at time of assessment).

## AN age of onset
```{r AN age of onset}
# Check for AN
dat %>%
  freq(age_at_low_weight)

# Change answers to whole numbers (rounding down)
dat$age_at_low_weight[dat$age_at_low_weight == "13 or 14"] <- 13
dat$age_at_low_weight[dat$age_at_low_weight == "14.5"] <- 14
dat$age_at_low_weight[dat$age_at_low_weight == "15.75"] <- 15
dat$age_at_low_weight[dat$age_at_low_weight == "16-18"] <- 16
dat$age_at_low_weight[dat$age_at_low_weight == "17.5"] <- 17
dat$age_at_low_weight[dat$age_at_low_weight == "18.5"] <- 18
dat$age_at_low_weight[dat$age_at_low_weight == "19.5"] <- 19
dat$age_at_low_weight[dat$age_at_low_weight == "47/48"] <- 47
dat$age_at_low_weight[dat$age_at_low_weight == "9.5"] <- 9

# Convert answers that have been converted to dates by an automatic function in Excel to plausible values (taking lower value)
dat$age_at_low_weight[dat$age_at_low_weight == "11-Dec"] <- 11

# Convert to numeric 
dat$age_at_low_weight <- as.numeric(dat$age_at_low_weight)

dat$age_at_low_weight[dat$age_at_low_weight > 117] <- NA_real_ # The oldest person in the world is 117 years
dat$age_at_low_weight[dat$age_at_low_weight < 4] <- NA_real_ # Lowest age of onset

# Check again for AN
dat %>%
  freq(age_at_low_weight)

# Rename
dat$AN_age_of_onset <- dat$age_at_low_weight
```

## Binge eating age of onset
```{r BE age of onset}
# Check for BE
dat %>%
  freq(age_of_onset_bingeing)

# Change answers to whole numbers
dat$age_of_onset_bingeing[dat$age_of_onset_bingeing == "15/16"] <- 15
dat$age_of_onset_bingeing[dat$age_of_onset_bingeing == "less than 17"] <- 16
dat$age_of_onset_bingeing[dat$age_of_onset_bingeing == "young teenager"] <- 14

# Convert answers that have been converted to dates by an automatic function in Excel to plausible values (taking lower value)
dat$age_of_onset_bingeing[dat$age_of_onset_bingeing == "Dec-13"] <- 12

# Convert to numeric 
dat$age_of_onset_bingeing <- as.numeric(dat$age_of_onset_bingeing)

dat$age_of_onset_bingeing[dat$age_of_onset_bingeing > 117] <- NA_real_ # The oldest person in the world is 117 years
dat$age_of_onset_bingeing[dat$age_of_onset_bingeing < 4] <- NA_real_ # Lowest age of onset?

# Check again for BE
dat %>%
  freq(age_of_onset_bingeing)

# Rename
dat$BE_age_of_onset <- dat$age_of_onset_bingeing
```    
  
## Gender   
```{r Gender}
# Check
dat %>%
  freq(gender)
```

## Cases: Minimum lifetime eating disorder-related body mass index (BMI)
```{r Minimum lifetime eating disorder-related body mass index (BMI)}
# Check
dat %>%
  freq(AN_BMI)
```

## Maximum lifetime BMI
```{r Maximum lifetime BMI}
# Convert height in ft and inches to metres 
dat$current_height_m_1 <- dat$current_height_ft/3.281

dat$current_height_m_2 <- as.numeric(dat$current_height_inches)/39.37

dat$current_height_m <- dat$current_height_m_1 + dat$current_height_m_2

# Check
freq(dat$current_height_m)

# Work out max BMI
dat$max_lifetime_BMI <- as.numeric(dat$highest_weight_kg) / as.numeric(dat$current_height_m)^2

# Check
head(dat$highest_weight_kg)
head(dat$current_height_m)
head(dat$max_lifetime_BMI)

# Check all plausbile values
descr(dat$max_lifetime_BMI) # All values are between 10 and 64 so all plausible
```    

## BMI at time of assessment
NB: BMI at time of assessment was assessed twice; once on Redcap, the other on Qualtrics. Therefore, if the person reaches case criteria on Qualtrics but not Redcap, I will take their BMI from Qualtrics (and vice versa). If they meet case criteria on both, I will take the BMI from Redcap as this was the first collected.

### Work out Current BMI from qualtrics (at time of assessment)
```{r Current BMI from qualtrics (at time of assessment)}
# Work out current BMI
dat$current_BMI <- as.numeric(dat$current_weight_kg) / as.numeric(dat$current_height_m)^2

# Check
head(dat$current_weight_kg)
head(dat$current_height_m)
head(dat$current_BMI)

# Check all plausbile values
descr(dat$current_BMI) # All values are between 10 and 49 so all plausible
```    

### BMI assessed twice - assigning correct value
```{r BMI assessed twice}
dat <- dat %>%
  mutate(BMI_time_of_assessment_final =
           case_when(
                   # Met criteria for BE_broad or BE_narrow on RedCap
                       ((diagnosis_BN == 1 | 
                       reg_info_BN == 1 |
                       reg_info_BN_broad == 1 |
                       reg_info_BN == 1 |
                       prim_second_diag_AN  == 1 | # Met criteria for anorexia on RedCap
                       AN_registration  == 1 |
                       AN_100K == 1) &
                       !is.na(core_bmi_x)) ~ core_bmi_x, # Core BMI x
                     
                   # Met criteria for BE_broad or BE_narrow on RedCap
                       ((diagnosis_BN == 1 | 
                       reg_info_BN == 1 |
                       reg_info_BN_broad == 1 |
                       reg_info_BN == 1 |
                       prim_second_diag_AN  == 1 | # Met criteria for anorexia on RedCap
                       AN_registration  == 1 |
                       AN_100K == 1) &
                       !is.na(core_bmi_y)) ~ core_bmi_y, # If no core BMI x, then core BMI y
                       
                   # Met criteria for BE_broad, BE_narrow, or anorexia on Qualtrics
                       ((binge_eating_loss_control_DSM5 == 1 |  
                       binge_eating_loss_control_DSM5 == 1 |
                       DSM5_AN_binary_numeric == 1) &
                       !is.na(current_BMI)) ~ current_BMI, # Then use derived BMI from info on Qualtrics
                   
                  # Capture people left over (Added this because there were 114 people with BMI data on Qualtrics who had not been assigned a final BMI variable [because they must have not met criteria on Qualtrics]. There was also one person with data on core_bmi_y with no final BMI data. Strictly speaking this will not be their BMI at the assessment in which they met criteria to be included in the case sample)
                   !is.na(core_bmi_x) ~ core_bmi_x,
                   !is.na(core_bmi_y) ~ core_bmi_y,
                   !is.na(current_BMI) ~ current_BMI
           )
  )
     
# Check
dat %>%
  freq(BMI_time_of_assessment_final)

# Are there any people missing current BMI who have reported it somewhere?
dat %>%
  filter(is.na(BMI_time_of_assessment_final)) %>%
  freq(current_BMI)

dat %>%
  filter(is.na(BMI_time_of_assessment_final)) %>%
  freq(core_bmi_y)

dat %>%
  filter(is.na(BMI_time_of_assessment_final)) %>%
  freq(core_bmi_x)
```

# Save dataset
Select variables to save
```{r Select variables to save}
dat.final <- dat %>%
  select(ID,
         BMI_time_of_assessment = BMI_time_of_assessment_final,
         BMI_max_lifetime = max_lifetime_BMI,
         BMI_min_ED_related = AN_BMI,
         gender,
         BE_age_of_onset,
         AN_age_of_onset,
         AN = AN_case,
         ANR = ANR_case,
         ANBP = ANBP_case,
         BE_broad,
         BE_narrow)

# Select only cases for PGC GWAS 
dat.final <- dat.final %>%
  filter(AN == 1 |
         ANR == 1 |
         ANBP == 1 |
         BE_broad == 1 |
         BE_narrow == 1)

# Count number of rows
dat.final %>%
  nrow()
```

# Duplicate IDS and checking entries match
Sometimes in this dataset, new entries were entered again rather than combining them with the participant's previous entry, resulting in many duplicated IDs. I am going to check that, for the participants with duplicated IDs, their data entries on each variable of interest are the same.
```{r duplicated IDs final data check}
# Identify dup IDs
duplicates <- dat.final[duplicated(dat.final$ID), ]

duplicates.ids <- duplicates %>%
  pull(ID)

# Check that duplicate IDs have same info on final variables
dat.final %>%
  select(ID,
         AN,
         ANR,
         ANBP,
         BE_broad,
         BE_narrow,
         BMI_time_of_assessment,
         BMI_max_lifetime,
         BMI_min_ED_related,
         gender,
         BE_age_of_onset,
         AN_age_of_onset) %>%
  filter(ID %in% duplicates.ids) %>%
  group_by(ID)
```

One person (ID = 14073) has marginally different:
- BMI time of assessment (18.74705 v 18.35649)
- BMI max lifetime (21.48100 v 19.91874)
- BMI min ED related (14.88047 v 15.62254)
as well as answers to whether they received intensive outpatient treatment etc...

Check their data
```{r}
dat.final %>%
  filter(ID == 14073)
```
This person has different entries for lowest weight kg (45 v 43) and highest weight (55 and 51) and therefore different entries for lowest weight AN, which is derived from lowest weight kg (38.1 v 40). Some of their data entries are slightly different too..e.g. has endorsed "Partial hospitalisation/ Day care treatment" in one questionnaire but not another, and "Making yourself vomit" at low weight in one but not the other...

Update (20/9/21): spoke with Henry and this is likely because of human error when entering this person's answers onto Qualtrics. Will drop this participant.

Drop participant
```{r}
dat.final <- dat.final %>%
  filter(ID != 14073)
```

Otherwise, can now drop all duplicated IDs as all other data entries for each participant match, so it doesn't matter which row we keep.
```{r Remove dup IDs}
dat.final.no.dup <- dat.final[!duplicated(dat.final$ID), ]
nrow(dat.final.no.dup)
```

# Check final numbers
```{r Count AN}
dat.final.no.dup %>%
  select(AN,
         ANR,
         ANBP) %>%
  count(AN,
         ANR,
         ANBP)

dat.final.no.dup %>%
  freq(AN)

dat.final.no.dup %>%
  freq(ANR)

dat.final.no.dup %>%
  freq(ANBP)
```

```{r Count BE_broad and BE_narrow}
dat.final.no.dup %>%
  freq(BE_broad)

 dat.final.no.dup %>%
  freq(BE_narrow)
```

```{r crossover of cases}
dat.final.no.dup %>%
  select(AN,
         BE_broad,
         BE_narrow) %>%
  count(AN,
         BE_broad,
         BE_narrow)

dat.final.no.dup %>%
  select(ANR,
         BE_broad,
         BE_narrow) %>%
  count(ANR,
         BE_broad,
         BE_narrow)

dat.final.no.dup %>%
  select(ANBP,
         BE_broad,
         BE_narrow) %>%
  count(ANBP,
         BE_broad,
         BE_narrow)
```

```{r Save dataset}
colnames(dat.final.no.dup)

saveRDS(object = dat.final.no.dup, file = paste0("/Users/helenadavies/King's College London/MT-Translational Neuropsychiatric Genomics - Helena_Davies_PhD - Helena_Davies_PhD/PGC_Freeze3_cases/data_cleaned/data.CharlottesHelix.cleaned", date, ".rds"))
```

# Save as text pheno file
```{r save as text file}
# Create FID column
dat.final.no.dup$FID <- dat.final.no.dup$ID

dat.final.no.dup %>%
  select(IID = ID,
         FID,
         BE_narrow,
         BE_broad,
         AN,
         ANR,
         ANBP) %>%
  write.table(file = "../pheno_files/charlottes_helix/PGC_3_Charlottes_Helix_cases.txt",
              sep = "")

dat.final.no.dup %>%
  select(IID = ID,
         FID,
         BMI_time_of_assessment,
         BMI_max_lifetime,
         BMI_min_ED_related,
         gender,
         BE_age_of_onset,
         AN_age_of_onset) %>%
  write.table(file = "../pheno_files/charlottes_helix/PGC_3_Charlottes_Helix_covariates.txt",
              sep = "")
```