---
title: "UKB_PGCED3"
output: html_document
---

This script identifies eating disorder cases (specifically, AN, BE [broad] and BE [narrow]) within UK Biobank.

Four ways to identify cases:
   1. HES (Hospital Episode Statistics)
   2. Mental health questionnaire
   3. GP records
   4. Death records

# Set up
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Delete everything in your global environment
```{r Delete everything in your global environment}
remove(list = ls())
```

# Load packages
```{r load packages}
#install.packages("devtools")
library(devtools)

# Install Ken's UKB KCL package
#devtools::install_github("kenhanscombe/ukbkings",
#          dependencies = TRUE,
#           force = TRUE)
#
library(ukbkings)

#install.packages("DescTools")
library(DescTools)

#install.packages("stringi")
#library(stringi)

#install.packages("tidyverse")
library(tidyverse)
```

You need a file with required fields, one per line, no header.
```{r obtain file with required fields}
# Point to the project directory
project_dir <- "/scratch/datasets/ukbiobank/ukb18177"

# Read the project field-to-name “field finder” file
f <- ukbkings::bio_field(project_dir)

# inspect the variable metadata
head(f)
glimpse(f)

# display the number of baskets included.
f %>%
distinct(basket)
```

```{r Search for variables required }
f %>%
select(name, field) %>%
page(method = "print")
```

Add their field codes to a file, one per line, no header. You can page through the file.
```{r add field codes to file}
strings <- c("eid",
             "20544")

f %>%
select(field, name) %>%
filter(str_detect(field,
                  paste(strings, collapse = "|"))) %>%
  bio_field_add("small_field_subset.txt")
```

Read required fields and save as an rds file in your user directory. Argument out should be a path to your UKB user directory
```{r save required fields as rds}
bio_phen(
 project_dir,
 field = "small_field_subset.txt",
 out = "small_phenotype_subset"
)
```

Check the size of your file and read in your dataset
```{r read in dataset}
system("ls -lh small_phenotype_subset.rds")
df <- readRDS("small_phenotype_subset.rds")
```

Rename columns from the default UKB field names to the descriptive names used in the field-to-name “field finder” name column.
```{r rename columns using bio_rename}
df <- bio_rename(df, f)
nrow(df)
```

# MHQ: Mental health problems ever diagnosed by a professional ###
## Coding for diagnoses by healthcare professional
1	Social anxiety or social phobia
2	Schizophrenia
3	Any other type of psychosis or psychotic illness
4	A personality disorder
5	Any other phobia (eg disabling fear of heights or spiders)
6	Panic attacks
7	Obsessive compulsive disorder (OCD)
10	Mania, hypomania, bipolar or manic-depression
11	Depression
12	Bulimia nervosa
13	Psychological over-eating or binge-eating
14	Autism, Asperger's or autistic spectrum disorder
15	Anxiety, nerves or generalized anxiety disorder
16	Anorexia nervosa
17	Agoraphobia
18	Attention deficit or attention deficit and hyperactivity disorder (ADD/ADHD)
-818	Prefer not to answer (group A)
-819	Prefer not to answer (group B)

### Anorexia nerovsa
```{r MHQ anorexia nervosa}
df <- df %>%
  mutate(AN_MHQ = 
           case_when(mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_1 == "16" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_2 == "16" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_3 == "16" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_4 == "16" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_5 == "16" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_6 == "16" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_7 == "16" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_8 == "16" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_9 == "16" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_10 == "16" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_11 == "16" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_12 == "16" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_13 == "16" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_14 == "16" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_15 == "16" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_16 == "16" ~ 1
           ))

df %>%
  count(AN_MHQ) # 891
```

### Bulimia nervosa
```{r MHQ bulimia nervosa}
df <- df %>%
  mutate(BN_MHQ =
           case_when(
          mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_1 == "12" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_2 == "12" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_3 == "12" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_4 == "12" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_5 == "12" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_6 == "12" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_7 == "12" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_8 == "12" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_9 == "12" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_10 == "12" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_11 == "12" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_12 == "12" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_13 == "12" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_14 == "12" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_15 == "12" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_16 == "12" ~1
          )
  )

df %>%
  count(BN_MHQ) # 503
```

### Psychological over-eating or binge-eating
NB: This can only be included in PRS. These people should be excluded from controls AND cases.
```{r MHQ psych overeating or binge eating}
df <- df %>%
  mutate(psych_overeating_or_BE_MHQ =
           case_when(
          mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_1 == "13" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_2 == "13" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_3 == "13" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_4 == "13" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_5 == "13" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_6 == "13" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_7 == "13" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_8 == "13" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_9 == "13" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_10 == "13" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_11 == "13" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_12 == "13" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_13 == "13" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_14 == "13" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_15 == "13" |
           mental_health_problems_ever_diagnosed_by_a_professional_f20544_0_16 == "13" ~ 1
     )
  )


df %>%
  count(psych_overeating_or_BE_MHQ) #707
```

Select columns
```{r MHQ select columns}
MHQ_dat <- df %>%
  select(eid,
         AN_MHQ,
         BN_MHQ,
         psych_overeating_or_BE_MHQ)

# Check
colnames(MHQ_dat)

nrow(MHQ_dat) # 502,538
```

Filter out non-cases (to make dataset smaller)
```{r MHQ filter out non-cases}
MHQ_dat_cases <- MHQ_dat %>%
  filter(AN_MHQ == 1 |
          BN_MHQ == 1)

# Not selecting "psychological overeating or binge eating" as this can only be used in PRS

nrow(MHQ_dat_cases) # 1252
```
 
Remove mhq dat to save memory (only need MHQ_dat_cases)
```{r MHQ remove mhq dat to save memory}
rm(MHQ_dat)
rm(df)
gc()
```

# HES in-patient data 
NB: Within the hospital inpatient dataset, each inpatient episode for a participant is stored as a single record, i.e. a row of data, or as multiple contiguous records. This is unlike the format of the UK Biobank main dataset, which provides a single row of data per participant. See here: https://biobank.ndph.ox.ac.uk/showcase/ukb/docs/HospitalEpisodeStatistics.pdf
```{r HES read in diagnosis data}
hesin_diag_diskframe <- bio_record(project_dir, record = "hesin_diag")

hesin_diag <- hesin_diag_diskframe %>%
    select(eid,
           diag_icd9,
           diag_icd10,
           ) %>%
    collect()

nrow(hesin_diag)
colnames(hesin_diag)
```

## ICD9 - WHO International Classification of Diseases
```{r HES ICD9 cases}
# Anorexia nervosa
hesin_diag <- hesin_diag %>%
  mutate(ICD9_AN =
           case_when(diag_icd9 == "3071" ~ 1
            ))

hesin_diag %>%
  count(ICD9_AN) # 1

# Other and unspecified disorders of eating (overeating)
hesin_diag <- hesin_diag %>%
  mutate(ICD9_overeating =
           case_when(diag_icd9 == "30752" ~ 1
            ))

hesin_diag %>%
  count(ICD9_overeating) # 0


# Polyphagia
hesin_diag <- hesin_diag %>%
  mutate(ICD9_polyphagia =
           case_when(diag_icd9 == "7836" ~ 1
            ))

hesin_diag %>%
  count(ICD9_polyphagia) # 1
```

## ICD10 - WHO International Classification of Diseases
```{r HES ICD10 cases}
# Anorexia nervosa
hesin_diag <- hesin_diag %>%
  mutate(ICD10_AN =
           case_when(diag_icd10 == "F500" ~ 1
            ))

hesin_diag %>%
  count(ICD10_AN) # 255

# Atypical anorexia nervosa
hesin_diag <- hesin_diag %>%
  mutate(ICD10_AAN =
           case_when(diag_icd10 == "F501" ~ 1
            ))

hesin_diag %>%
  count(ICD10_AAN)  # 11

# Bulimia nervosa
hesin_diag <- hesin_diag %>%
  mutate(ICD10_BN =
           case_when(diag_icd10 == "F502" ~ 1
            ))

hesin_diag %>%
  count(ICD10_BN)  # 80

# Atypical bulimia nervosa
hesin_diag <- hesin_diag %>%
  mutate(ICD10_ABN =
           case_when(diag_icd10 == "F503" ~ 1
            ))

hesin_diag %>%
  count(ICD10_ABN)  # 0


# Overeating associated with other psychological disturbances
hesin_diag <- hesin_diag %>%
  mutate(ICD10_overeating =
           case_when(diag_icd10 == "F504" ~ 1
            ))

hesin_diag %>%
  count(ICD10_overeating)  # 0
```

Create new dataframes of each disorder then merge by eid (because each row is a data entry rather than a participant [i.e., a participant may have reported HES multiple times], need to create a dataframe without any duplicated IDs. Have only included ICD9/10 codes that had >0 participants' endorsement)
```{r HES new dataframe of each disorder anorexia nervosa}
# Anorexia nervosa
hesin_AN <- hesin_diag %>%
  filter(ICD9_AN == 1 |
          ICD10_AN == 1 
           )

hesin_AN$ICD_AN <- 1

hesin_AN <- hesin_AN %>%
  select(eid, 
         ICD_AN)

# check no. of rows
nrow(hesin_AN)

# check no. of unique IDs 
length(unique(hesin_AN$eid))

# Keep only unique IDs
hesin_AN <- hesin_AN %>% 
  distinct(eid, .keep_all = TRUE) 
```

```{r HES new dataframe of each disorder polyphagia}
# Polyphagia
hesin_polyphagia <- hesin_diag %>%
  filter(ICD9_polyphagia == 1)

hesin_polyphagia$ICD9_polyphagia <- 1 

hesin_polyphagia <- hesin_polyphagia %>%
  select(eid, 
         ICD9_polyphagia)

# check no. of rows
nrow(hesin_polyphagia)

# check no. of unique IDs 
length(unique(hesin_polyphagia$eid))

# Keep only unique IDs
hesin_polyphagia <- hesin_polyphagia %>% 
  distinct(eid, .keep_all = TRUE) 
```

```{r HES new dataframe of each disorder atypical anorexia nervosa}
# Atypical anorexia nervosa
hesin_AAN <- hesin_diag %>%
  filter(ICD10_AAN == 1)

hesin_AAN$ICD10_AAN <- 1 

hesin_AAN <- hesin_AAN %>%
  select(eid, 
         ICD10_AAN)

# check no. of rows
nrow(hesin_AAN)

# check no. of unique IDs - mismatch! need to get rid of dup IDs before merging
unique(hesin_AAN$eid)

# Keep only unique IDs
hesin_AAN <- hesin_AAN %>% 
  distinct(eid, .keep_all = TRUE) 
```


```{r HES new dataframe of each disorder atypical bulimia nervosa}
# Bulimia nervosa
hesin_BN <- hesin_diag %>%
  filter(ICD10_BN == 1)

hesin_BN$ICD10_BN <- 1 

hesin_BN <- hesin_BN %>%
  select(eid, 
         ICD10_BN)

# check no. of rows
nrow(hesin_BN)
# check no. of unique IDs - mismatch! need to get rid of dup IDs before merging
unique(hesin_BN$eid)

# Keep only unique IDs
hesin_BN <- hesin_BN %>% 
  distinct(eid, .keep_all = TRUE) 
```

```{r HES merge by ID}
# Merge by ID
hesin_merged_ID <- list(
  hesin_AN,
  hesin_polyphagia,
  hesin_AAN,
  hesin_BN) %>% 
  reduce(full_join, 
         by = "eid"
  )

# Check
hesin_merged_ID %>%
  colnames()

hesin_merged_ID %>%
  nrow()

# Check same as nrow
length(unique(hesin_merged_ID$eid))
```

Remove HES data to save memory (only need hesin_merged_ID)
```{r HES remove to save memory}
rm(hesin_AN)
rm(hesin_polyphagia)
rm(hesin_AAN)
rm(hesin_BN)
gc()
```

# HES data exclusion criteria 
(NB: this will be applied to GP "anorexia" cases, not HES data)

## Malignant neoplasms ICD9
```{r HES data exclusion criteria malignant neoplasms ICD9}
# Convert empty spaces to NA
hesin_diag <- mutate_all(hesin_diag, list(~na_if(.,"")))

# Malignant neoplasms - ICD9
hesin_diag_exclusion <- hesin_diag %>%
  mutate(malignant_neoplasms_ICD9 =
           case_when(
                       (diag_icd9 > 1400 &
                       diag_icd9 < 2100) |
                         
                         (diag_icd9 > 140 &
                         diag_icd9 < 210) ~ 1,
                       
                       is.na(diag_icd9) ~ NA_real_,
                       
                       TRUE ~ 0
                     )
         )
         

hesin_diag_exclusion %>%
  count(malignant_neoplasms_ICD9) # 2117

# Create dataset of malignant neoplasm cases
hesin_malignant_neo_ICD9_case <- hesin_diag_exclusion %>%
  filter(malignant_neoplasms_ICD9 == 1) 

hesin_malignant_neo_ICD9_case <- hesin_malignant_neo_ICD9_case %>%
  select(eid, 
         malignant_neoplasms_ICD9)

# check no. of rows
nrow(hesin_malignant_neo_ICD9_case)
# check no. of unique IDs - mismatch! need to get rid of dup IDs before merging
length(unique(hesin_malignant_neo_ICD9_case$eid))

# Filter out non-unique IDs
hesin_malignant_neo_ICD9_case <- hesin_malignant_neo_ICD9_case %>% 
  distinct(eid,
           .keep_all = TRUE) 
```

Create dataset of people without malignant neoplasms 
```{r HES data exclusion criteria NO malignant neoplasms ICD9}
hesin_malignant_neo_ICD9_not_case <- hesin_diag_exclusion %>%
  filter(malignant_neoplasms_ICD9 == 0) 

hesin_malignant_neo_ICD9_not_case$no_malignant_neoplasms_ICD9 <- 1

hesin_malignant_neo_ICD9_not_case <- hesin_malignant_neo_ICD9_not_case %>%
  select(eid, 
         no_malignant_neoplasms_ICD9)

# check no. of rows
nrow(hesin_malignant_neo_ICD9_not_case)
# check no. of unique IDs - mismatch! need to get rid of dup IDs before merging
length(unique(hesin_malignant_neo_ICD9_not_case$eid))

# Filter out non-unique IDs
hesin_malignant_neo_ICD9_not_case <- hesin_malignant_neo_ICD9_not_case %>% 
  distinct(eid, .keep_all = TRUE) 
```

Merge the two datasets
```{r HES data exclusion criteria malignant neoplasms ICD9 merged}
hesin_malignant_neo_ICD_9_ID <- list(
  hesin_malignant_neo_ICD9_case,
  hesin_malignant_neo_ICD9_not_case
  ) %>% 
  reduce(full_join, 
         by = "eid"
  )

# Check
hesin_malignant_neo_ICD_9_ID %>%
  nrow()

length(unique(hesin_malignant_neo_ICD_9_ID$eid))

hesin_malignant_neo_ICD_9_ID %>%
  count(malignant_neoplasms_ICD9)

hesin_malignant_neo_ICD_9_ID %>%
  count(no_malignant_neoplasms_ICD9)
# Now have a dataset with no dup IDs, and one column for malignant neoplasms (1 or NA) and the other for no malignant neoplasms (1 or NA). You can only be a true "no malignant neoplasms" if you also do NOT have a 1 in the other column.
```

## Neoplasms ICD9
```{r HES data exclusion criteria ICD9 neoplasms}
## Neoplasms - ICD9
hesin_diag_exclusion <- hesin_diag_exclusion %>%
  mutate(neoplasms_ICD9 =
           case_when(
                       (diag_icd9 > 2300 &
                       diag_icd9 < 2400) |
                         
                         (diag_icd9 > 230 &
                         diag_icd9 < 240) ~ 1,
                       
                       is.na(diag_icd9) ~ NA_real_,
                       
                      TRUE ~ 0
                     )
         )

hesin_diag_exclusion %>%
  count(neoplasms_ICD9) # 244

# Create dataset of cases
hesin_neo_ICD9_case <- hesin_diag_exclusion %>%
  filter(neoplasms_ICD9 == 1) 

hesin_neo_ICD9_case <- hesin_neo_ICD9_case %>%
  select(eid, 
         neoplasms_ICD9)

# check no. of rows
nrow(hesin_neo_ICD9_case)
# check no. of unique IDs - mismatch! need to get rid of dup IDs before merging
length(unique(hesin_neo_ICD9_case$eid))

hesin_neo_ICD9_case <- hesin_neo_ICD9_case %>% 
  distinct(eid, .keep_all = TRUE) 

```

```{r HES data exclusion criteria NO ICD9 neoplasms}
# Create dataset of people with NO neoplasms
hesin_neo_ICD9_not_case <- hesin_diag_exclusion %>%
  filter(neoplasms_ICD9 == 0) 

hesin_neo_ICD9_not_case$no_neoplasms_ICD9 <- 1

hesin_neo_ICD9_not_case <- hesin_neo_ICD9_not_case %>%
  select(eid, 
         no_neoplasms_ICD9)

# check no. of rows
nrow(hesin_neo_ICD9_not_case)
# check no. of unique IDs - mismatch! need to get rid of dup IDs before merging
length(unique(hesin_neo_ICD9_not_case$eid))

hesin_neo_ICD9_not_case <- hesin_neo_ICD9_not_case %>% 
  distinct(eid, .keep_all = TRUE) 
```

```{r HES data exclusion criteria ICD9 neoplasms merge data}
# Merge the two datasets
hesin_neo_ID <- list(
  hesin_neo_ICD9_case,
  hesin_neo_ICD9_not_case
  ) %>% 
  reduce(full_join, 
         by = "eid"
  )


# Check
hesin_neo_ID %>%
  nrow()

length(unique(hesin_neo_ID$eid))

hesin_neo_ID %>%
  count(neoplasms_ICD9)

hesin_neo_ID %>%
  count(no_neoplasms_ICD9)
```

## Malignant neoplasms ICD10
C00 -D09 & D37 -D49
```{r HES data exclusion criteria ICD10 malignant neoplasms}
M_NEO <- c("C0",
            "C1",
           "C2",
            "C3",
           "C4",
           "C5",
           "C6",
            "C7",
           "C8",
            "C9",
           "D0",
           
           "D37",
            "D38",
           "D39",
            "D40",
           "D41",
           "D42",
           "D43",
            "D44",
           "D45",
            "D46",
           "D47",
           "D48",
            "D49"
           )

# MALIGNANT NEOPLASMS
# Identify all data entries of an ICD10 code of malignant neoplasm
hesin_diag_exclusion_ICD10 <- hesin_diag_exclusion %>%
  filter(str_detect(diag_icd10,
                  paste(M_NEO)))

# Create new column to indicate malginant neoplasm according to ICD-10
hesin_diag_exclusion_ICD10$ICD10_malignant_neo <- 1

hesin_diag_exclusion_ICD10 %>%
  count(ICD10_malignant_neo)

length(unique(hesin_diag_exclusion_ICD10$eid))

# Select only unique IDs
hesin_diag_exclusion_ICD10_ID <- hesin_diag_exclusion_ICD10 %>% 
  distinct(eid, .keep_all = TRUE) 
```

Identify all data entries NOT of an ICD10 code of malignant neoplasm
```{r HES data exclusion criteria ICD10 NO malignant neoplasms}
# NO MALIGNANT NEOPLASMS
hesin_diag_NOT_exclusion_ICD10 <- hesin_diag_exclusion %>%
  filter(!str_detect(diag_icd10,
                  paste(M_NEO)))

# Test what happens to NAs
test_NA <- hesin_diag_NOT_exclusion_ICD10 %>%
  filter(is.na(diag_icd10))

test_NA %>% # No NAs
  nrow()

# Create new column to indicate NO malginant neoplasm according to ICD-10
hesin_diag_NOT_exclusion_ICD10$ICD10_NO_malignant_neo <- 1

hesin_diag_NOT_exclusion_ICD10 %>%
  count(ICD10_NO_malignant_neo)

# See how many of the data entries are from unique IDs
length(unique(hesin_diag_NOT_exclusion_ICD10$eid))

# Select only unique IDs
hesin_diag_NOT_exclusion_ICD10_ID <- hesin_diag_NOT_exclusion_ICD10 %>% 
  distinct(eid, .keep_all = TRUE) 
```

Merge two datasets
```{r HES data exclusion criteria ICD10 malignant neoplasms merge datasets}
# Merge the two datasets
hesin_malignant_neo_ICD_10_ID <- list(
  hesin_diag_exclusion_ICD10_ID, # Participants who at some point have met exclusion criteria
  hesin_diag_NOT_exclusion_ICD10_ID # Participants who at some point have not met exclusion criteria (might overlap with above)
  ) %>% 
  reduce(full_join, 
         by = "eid"
  )

# Select only needed columns
hesin_malignant_neo_ICD_10_ID <- hesin_malignant_neo_ICD_10_ID %>%
  select(eid,
        ICD10_NO_malignant_neo,
        ICD10_malignant_neo)

# Check
hesin_malignant_neo_ICD_10_ID %>%
  nrow()

length(unique(hesin_malignant_neo_ICD_10_ID$eid)) # Number of unique IDs is same as number of rows = no dup IDs!

hesin_malignant_neo_ICD_10_ID %>%
  count(ICD10_NO_malignant_neo)

hesin_malignant_neo_ICD_10_ID %>%
  count(ICD10_malignant_neo)
```

## Further exclusion criteria ICD9 & ICD10 (i.e., beyond neoplasms)
```{r HES data exclusion criteria further exclusion criteria} 
# Cases after exclusion
hesin_diag_exclusion <- hesin_diag_exclusion %>%
  mutate(other_exclusion_codes =
           case_when(
              
          # ICD9 exclusion codes
           (diag_icd9 == "5645" |           # Functional diarrhea
           diag_icd9 == "2780" |            # Obesity
           diag_icd9 == "5569" |            # Idiopathic proctocolitis 
           diag_icd9 == "5303" |            # Stricture and stenosis of esophagus
           diag_icd9 == "5305" |            # Dyskinesia of esophagus
           diag_icd9 == "5308" |            # Other specified disorders of esophagus
            
         # ICD10 exclusion codes
          diag_icd10 == "K591"  |         # Functional diarrhea
          diag_icd10 == "E660"  |         # Obesity due to excess calories
          diag_icd10 == "K518"  |         # Other ulcerative colitis
          diag_icd10 == "K512"  |         # Ulcerative (chronic) proctitis
          diag_icd10 == "K513"  |         # Ulcerative (chronic) rectosigmoiditis
          diag_icd10 == "K514"  |         # Pseudopolyposis of colon
          diag_icd10 == "K515"  |         # Mucosal proctocolitis
          diag_icd10 == "K519"  |         # Ulcerative colitis, unspecified
          diag_icd10 == "K222"  |         # Oesophageal obstruction
          diag_icd10 == "K224"  |         # Dyskinesia of oesophagus
          diag_icd10 == "K228"  |         # Other specified diseases of oesophagus
          diag_icd10 == "K219"  |         # Gastro-oesophageal reflux disease without oesophagitis
          diag_icd10 == "J860"  |         # Pyothorax with fistula
          diag_icd10 == "K227"  |         # Barrett's oesophagus
          diag_icd10 == "K229"  |         # Disease of oesophagus, unspecified
          diag_icd10 == "F840"  |         # Childhood autism
          diag_icd10 == "F843"  |         # Other childhood disintegrative disorder
          diag_icd10 == "F845"  |         # Asperger's syndrome
          diag_icd10 == "F848"   |        # Other pervasive developmental disorders
          diag_icd10 == "F849")  ~ 1,     # Pervasive developmental disorder, unspecified
         
          diag_icd9 != "5645" ~ 0, # Every data entry that is NOT this one (and also would NOT be any of the others above due to the nature of case_when). This captures people who have AN entry in ICD9, but not one that meets exclusion criteria. (+++ HLD - to check this. I wrote this a while ago and now can't remember why I did it like this...)
           
         is.na(diag_icd9) |
          is.na(diag_icd10) ~ NA_real_, # Doesn't have any HES data (Entries with any non-exclusion criteria)
           
         TRUE ~ 0
          
          )
  )

# Check number
hesin_diag_exclusion %>% 
  count(other_exclusion_codes) 

# Create dataset of cases
hesin_other_exclusion_codes_case <- hesin_diag_exclusion %>%
  filter(other_exclusion_codes == 1) 

hesin_other_exclusion_codes_case <- hesin_other_exclusion_codes_case %>%
  select(eid, 
         other_exclusion_codes)

# check no. of rows
nrow(hesin_other_exclusion_codes_case)
# check no. of unique IDs - mismatch! need to get rid of dup IDs before merging
length(unique(hesin_other_exclusion_codes_case$eid))

hesin_other_exclusion_codes_case <- hesin_other_exclusion_codes_case %>% 
  distinct(eid, .keep_all = TRUE) 
```

Create dataset of entries not meeting exclusion criteria 
```{r HES data exclusion criteria NO further exclusion criteria}
hesin_other_exclusion_codes_not_case <- hesin_diag_exclusion %>%
  filter(other_exclusion_codes == 0) 

hesin_other_exclusion_codes_not_case$no_other_exclusion_code <- 1

hesin_other_exclusion_codes_not_case <- hesin_other_exclusion_codes_not_case %>%
  select(eid, 
         no_other_exclusion_code)

# check no. of rows
nrow(hesin_other_exclusion_codes_not_case)
# check no. of unique IDs - mismatch! need to get rid of dup IDs before merging
length(unique(hesin_other_exclusion_codes_not_case$eid))

hesin_other_exclusion_codes_not_case <- hesin_other_exclusion_codes_not_case %>% 
  distinct(eid, .keep_all = TRUE) 
```

Merge the two datasets
```{r HES data exclusion criteria further exclusion criteria merge dataset}
hesin_other_codes_ID <- list(
  hesin_other_exclusion_codes_case,
  hesin_other_exclusion_codes_not_case
  ) %>% 
  reduce(full_join, 
         by = "eid"
  )

# Check
hesin_other_codes_ID %>%
  nrow()

length(unique(hesin_other_codes_ID$eid))

hesin_other_codes_ID %>%
  count(other_exclusion_codes)

hesin_other_codes_ID %>%
  count(no_other_exclusion_code)
```

### Merge all hesin exclusion data with 
```{r Merge exclusion datasets}
hesin_exclusion_dat <- list(
  hesin_malignant_neo_ICD_10_ID, # Malignant neoplasms ICD10
  hesin_other_codes_ID, # Other ICD9 or ICD10 codes
  hesin_neo_ID, # Neoplasms (ICD9)
  hesin_malignant_neo_ICD_9_ID, # Malignant neoplasms ICD9
  hesin_merged_ID # Dataset containing people who meet inclusion criteria via HES data
  ) %>% 
  reduce(full_join, 
         by = "eid"
  )

# Check
hesin_exclusion_dat %>%
  colnames()

hesin_exclusion_dat %>%
  nrow()

length(unique(hesin_exclusion_dat$eid))
```

Identify people who meet at least one exclusion criteria
```{r identify people who meet at least one exclusion criteria}
hesin_exclusion_dat <- hesin_exclusion_dat %>%
  mutate(HES_exclusion_criteria =
           case_when(
           ICD10_malignant_neo == 1 |
           other_exclusion_codes == 1 |
           malignant_neoplasms_ICD9 == 1 |
           neoplasms_ICD9 == 1 ~ 1,
         
          TRUE ~ 0
           )
  )

hesin_exclusion_dat %>%
  count(HES_exclusion_criteria)

# Identify people with at least one HES data entry
hesin_exclusion_dat <- hesin_exclusion_dat %>%
  mutate(HES_data_entry =
           case_when(
           ICD10_NO_malignant_neo == 1 |
           no_other_exclusion_code == 1 |
           no_malignant_neoplasms_ICD9 == 1 |
           no_neoplasms_ICD9 == 1 ~ 1,
         
          TRUE ~ 0
           )
  )

hesin_exclusion_dat %>%
  count(HES_data_entry)
```

Remove dataframes not needed to save memory (only really need "hesin_exclusion_dat")
```{r HES remove dataframes to save memory}
rm(HES_data_cases)
rm(exclusion)
rm(hesin_diag)
rm(hesin_other_exclusion_codes_case)
rm(hesin_other_exclusion_codes_not_case)
rm(hesin_neo_ICD9_case)
rm(hesin_neo_ICD9_not_case)
rm(hesin_malignant_neo_ICD9_case)
rm(hesin_malignant_neo_ICD9_not_case)
rm(hesin_diag_exclusion_ICD10_ID)
rm(hesin_diag_NOT_exclusion_ICD10_ID)
rm(hesin_malignant_neo_ICD_10_ID)
rm(hesin_other_codes_ID)
rm(hesin_neo_ID)
rm(hesin_malignant_neo_ICD_9_ID)
gc()
```

# Death data 
This category contains coded data on the cause of death (International Classification of Diseases [ICD10]), obtained through linkage to national death registries.
```{r DEATH read in data }
death_cause_diskframe <- bio_record(project_dir, record = "death_cause")

death_cause <- death_cause_diskframe %>%
    select(eid,
           cause_icd10
           ) %>%
    collect()

nrow(death_cause)
```

Checking numbers in death data

Death due to atypical anorexia nervosa = 0
Death due to bulimia nervosa = 0 
Death due to atypical bulimia nervosa = 0
Death due to Overeating associated with other psychological disturbances = 0
```{r DEATH checking numbers in data}
# Death due to anorexia nervosa
death_data <- death_cause %>%
  mutate(death_due_to_AN =
           case_when(cause_icd10 == "F500" ~ 1
            ))

death_data %>%
  count(death_due_to_AN)  #3
```

Select columns
```{r DEATH select columns}
death_data_clean <- death_data %>%
  select(eid,
        death_due_to_AN)
```

Filter out non-cases
```{r DEATH filter out non-cases}
death_data_cases <- death_data_clean %>%
  filter(death_due_to_AN == 1)

# Check
colnames(death_data_cases)
nrow(death_data_cases)
```

Remove dataframes not needed
```{r DEATH remove dataframes to save memory}
rm(death_data_clean)
rm(death_data)
rm(death_cause)
gc()
```

# GP data
NB: Again, each row is a data entry rather than a participant.
```{r GP read in data}
gp_clinical_diskframe <- bio_record(project_dir, record = "gp_clinical")

gp_clinical <- gp_clinical_diskframe %>%
    select(eid,
           read_2,
           read_3
           
           ) %>%
    collect()

head(gp_clinical)
```

## Anorexia
### GP read 2 code: Anorexia nervosa
```{r GP read code 2 anorexia nervosa}
# E271 = 'Anorexia nervosa'
gp_clinical <- gp_clinical %>%
  mutate(read2_anorexia_nervosa =
           case_when(read_2 == "E271." ~ 1
           )
  )
             
gp_clinical %>%
  count(read2_anorexia_nervosa)  # 91

# Eu500 = '[X]Anorexia nervosa'
gp_clinical <- gp_clinical %>%
  mutate(read2_Xanorexia_nervosa =
           case_when(read_2 == "Eu500" ~ 1
           )
  )

gp_clinical %>%
  count(read2_Xanorexia_nervosa)  # 13

# Eu501 = 'Atypical anorexia nervosa'
gp_clinical <- gp_clinical %>%
  mutate(read2_atypical_anorexia_nervosa =
           case_when(read_2 == "Eu501" ~ 1
           )
  )

gp_clinical %>%
  count(read2_atypical_anorexia_nervosa)  # 13

# 1467 = 'H/OAnorexia nervosa'
gp_clinical <- gp_clinical %>%
  mutate(read2_HO_anorexia_nervosa =
           case_when(read_2 == "1467" ~ 1
           )
  )

gp_clinical %>%
  count(read2_HO_anorexia_nervosa)  #0
```

```{r GP read code 2 anorexia nervosa create dataset}
gp_anorexia_nervosa_read2 <- gp_clinical %>%
  filter(read2_HO_anorexia_nervosa == 1 |
           #read2_atypical_anorexia_nervosa == 1 | # These people do not count as cases (or controls)
           read2_Xanorexia_nervosa == 1 |
           read2_anorexia_nervosa == 1) 

gp_anorexia_nervosa_read2$GP_anorexia_nervosa_read2 <- 1

gp_anorexia_nervosa_read2 <- gp_anorexia_nervosa_read2 %>%
  select(eid, 
         GP_anorexia_nervosa_read2)

# check no. of rows
nrow(gp_anorexia_nervosa_read2)
# check no. of unique IDs
length(unique(gp_anorexia_nervosa_read2$eid))

# Keep distinct IDs
gp_anorexia_nervosa_read2 <- gp_anorexia_nervosa_read2 %>% 
  distinct(eid, .keep_all = TRUE) 

# Check that same amount of unique IDs as there are rows
gp_anorexia_nervosa_read2 %>%
  nrow()

length(unique(gp_anorexia_nervosa_read2$eid))

# Check
gp_anorexia_nervosa_read2 %>%
  count(GP_anorexia_nervosa_read2)
```

### GP read 2 code: Anorexia (these will need exclusion criteria)
```{r GP read code 2 anorexia need exclusion criteria}
# 1612 = Appetite loss - anorexia OR Anorexia symptom
gp_clinical <- gp_clinical %>%
  mutate(read2_anorexia_appetite_loss_OR_anorexia_symptom =
           case_when(read_2 == "1612" ~ 1
           )
  )

gp_clinical %>%
  count(read2_anorexia_appetite_loss_OR_anorexia_symptom)  # 0

# R030. = [D]Anorexia
gp_clinical <- gp_clinical %>%
  mutate(read2_DAnorexia =
           case_when(read_2 == "R030." ~ 1
           )
  )

gp_clinical %>%
  count(read2_DAnorexia)  # 54

# R030z = [D]Anorexia
gp_clinical <- gp_clinical %>%
  mutate(read2_AnorexiaNOS =
           case_when(read_2 == "R030z" ~ 1
           )
  )

gp_clinical %>%
  count(read2_AnorexiaNOS)  # 0
```

```{r GP read code 2 anorexia need create dataset}
gp_anorexia_read2 <- gp_clinical %>%
  filter(read2_AnorexiaNOS == 1 |
           read2_DAnorexia == 1 | 
           read2_anorexia_appetite_loss_OR_anorexia_symptom == 1
         ) 

gp_anorexia_read2$GP_anorexia_read2 <- 1

gp_anorexia_read2 <- gp_anorexia_read2 %>%
  select(eid, 
         GP_anorexia_read2)

# check no. of rows
nrow(gp_anorexia_read2)
# check no. of unique IDs - mismatch! need to get rid of dup IDs before merging
length(unique(gp_anorexia_read2$eid))

gp_anorexia_read2 <- gp_anorexia_read2 %>% 
  distinct(eid,
           .keep_all = TRUE) 

# Check that same amount of unique IDs as there are rows
gp_anorexia_read2 %>%
  nrow()

length(unique(gp_anorexia_read2$eid))

# Check
gp_anorexia_read2 %>%
  count(GP_anorexia_read2)
```

### GP read 3 code: Anorexia nervosa 
```{r GP read code 3 anorexia nervosa}
# E271. = 'Anorexia nervosa'
gp_clinical <- gp_clinical %>%
  mutate(read3_anorexia_nervosa =
           case_when(read_3 == "E271." ~ 1
           )
  )

gp_clinical %>%
  count(read3_anorexia_nervosa)  # 551

# X00Sz = 'Atypical anorexia nervosa'
gp_clinical <- gp_clinical %>%
  mutate(read3_atypical_anorexia_nervosa =
           case_when(read_3 == "X00Sz" ~ 1
           )
  )

gp_clinical %>%
  count(read3_atypical_anorexia_nervosa)  # 4 

# 1467 = 'H/O: anorexia nervosa'
gp_clinical <- gp_clinical %>%
  mutate(read3_HO_anorexia_nervosa =
           case_when(read_3 == "1467" ~ 1
           )
  )

gp_clinical %>%
  count(read3_HO_anorexia_nervosa)  # 0
```

```{r GP read code 3 anorexia nervosa create dataset}
gp_anorexia_nervosa_read3 <- gp_clinical %>%
  filter(read3_anorexia_nervosa == 1  
           #read3_atypical_anorexia_nervosa == 1 # Again, we have decided that these people will not count as cases (or controls)
           ) 

gp_anorexia_nervosa_read3$GP_anorexia_nervosa_read3 <- 1

gp_anorexia_nervosa_read3 <- gp_anorexia_nervosa_read3 %>%
  select(eid, 
         GP_anorexia_nervosa_read3)

# check no. of rows
nrow(gp_anorexia_nervosa_read3)
# check no. of unique IDs - mismatch! need to get rid of dup IDs before merging
length(unique(gp_anorexia_nervosa_read3$eid))

gp_anorexia_nervosa_read3 <- gp_anorexia_nervosa_read3 %>% 
  distinct(eid, .keep_all = TRUE) 

# Check that same amount of unique IDs as there are rows
gp_anorexia_nervosa_read3 %>%
  nrow()

length(unique(gp_anorexia_nervosa_read3$eid))

# Check
gp_anorexia_nervosa_read3 %>%
  count(GP_anorexia_nervosa_read3)
```

### GP read 3 code: Anorexia (these will need exclusion criteria)
```{r GP read code 3 anorexia need exclusion criteria}
# 1612 = Appetite loss: [anorexia] or [anorexia symptom] OR Anorexia symptom OR Appetite loss - anorexia
gp_clinical <- gp_clinical %>%
  mutate(read3_anorexia_appetite_loss_OR_anorexia_symptom =
           case_when(read_3 == "1612" ~ 1
           )
  )


gp_clinical %>%
  count(read3_anorexia_appetite_loss_OR_anorexia_symptom)  # 0

# R030. = [D]Anorexia
gp_clinical <- gp_clinical %>%
  mutate(read3_Danorexia =
           case_when(read_3 == "R030." ~ 1
           )
  )


gp_clinical %>%
  count(read3_Danorexia)  # 98

# R030z = Anorexia NOS
gp_clinical <- gp_clinical %>%
  mutate(read3_anorexiaNOS =
           case_when(read_3 == "R030z" ~ 1
           )
  )


gp_clinical %>%
  count(read3_anorexiaNOS)  # 37

#X76cG = Anorexia symptom
gp_clinical <- gp_clinical %>%
  mutate(read3_anorexia_symptom =
           case_when(read_3 == "X76cG" ~ 1
           )
  )


gp_clinical %>%
  count(read3_anorexia_symptom)  # 56

# XE24f = Appetite loss - anorexia
gp_clinical <- gp_clinical %>%
  mutate(read3_appetite_loss_anorexia =
           case_when(read_3 == "XE24f" ~ 1
           )
  )

gp_clinical %>%
  count(read3_appetite_loss_anorexia)  #240

# XM07X = Anorexia
gp_clinical <- gp_clinical %>%
  mutate(read3_anorexia =
           case_when(read_3 == "XM07X" ~ 1
           )
  )

gp_clinical %>%
  count(read3_anorexia)  # 151
```

```{r GP read code 3 anorexia create dataset}
gp_anorexia_read3 <- gp_clinical %>%
  filter(read3_anorexia_appetite_loss_OR_anorexia_symptom == 1 |
           read3_Danorexia == 1 |
           read3_anorexiaNOS == 1 |
           read3_anorexia_symptom == 1 |
           read3_appetite_loss_anorexia  == 1 |
           read3_anorexia == 1 
           ) 

gp_anorexia_read3$GP_anorexia_read3 <- 1

gp_anorexia_read3 <- gp_anorexia_read3 %>%
  select(eid, 
         GP_anorexia_read3)

# check no. of rows
nrow(gp_anorexia_read3)
# check no. of unique IDs 
length(unique(gp_anorexia_read3$eid))

gp_anorexia_read3 <- gp_anorexia_read3 %>% 
  distinct(eid, .keep_all = TRUE) 

# Check that same amount of unique IDs as there are rows
gp_anorexia_read3 %>%
  nrow()

length(unique(gp_anorexia_read3$eid))

gp_anorexia_read3 %>%
  count(GP_anorexia_read3)
```

## Binge eating
GP read 2 code: Binge eating
```{r GP read code 2 binge eating}
# 1FF.. = 'Binge eating'
gp_clinical <- gp_clinical %>%
  mutate(read2_binge_eating =
           case_when(read_2 == "1FF.." ~ 1
           )
  )


gp_clinical %>%
  count(read2_binge_eating)  # 10

# 1JZ.. = 'Suspected binge eating disorder'
gp_clinical <- gp_clinical %>%
  mutate(read2_suspected_binge_eating_disorder =
           case_when(read_2 == "1JZ.." ~ 1
           )
  )

gp_clinical %>%
  count(read2_suspected_binge_eating_disorder)  # 0

# Eu502 = '[X]Bulimia nervosa' OR '[X]Bulimia NOS'
gp_clinical <- gp_clinical %>%
  mutate(read_2_Xbulimia_nervosa_OR_bulimiaNOS =
           case_when(read_2 == "Eu502" ~ 1)
  )

gp_clinical %>%
  count(read_2_Xbulimia_nervosa_OR_bulimiaNOS) # 58

# Eu503 = '[X]Atypical bulimia nervosa'
gp_clinical <- gp_clinical %>%
  mutate(read_2_atypical_bulimia_nervosa =
           case_when(read_2 == "Eu503" ~ 1)
  )

gp_clinical %>%
  count(read_2_atypical_bulimia_nervosa) # 2 


# R0360 = '[D]Bulimia NOS' OR '[D]Excessive eating'
gp_clinical <- gp_clinical %>%
  mutate(read_2_bulimiaNOS_or_excessive_eating =
           case_when(read_2 == "R0360" ~ 1)
  )

gp_clinical %>%
  count(read_2_bulimiaNOS_or_excessive_eating) # 63


# E2751 = Bulimia (non-organic overeating)
gp_clinical <- gp_clinical %>%
  mutate(read_2_bulimia_nonorganic_overeating =
           case_when(read_2 == "E2751" ~ 1)
  )

gp_clinical %>%
  count(read_2_bulimia_nonorganic_overeating) # 41
```

### GP read code 3 binge eating
```{r GP read code 3 binge eating}
# X767Z = 'Binge eating' OR 'Bingeing' OR 'Bouts of overeating' OR 'Episodes of overeating' OR 'Binges'
gp_clinical <- gp_clinical %>%
  mutate(read_3_bingeeating_OR_bingeing_OR_overeating_OR_binges =
           case_when(read_3 == "X767Z" ~ 1)
  )

gp_clinical %>%
  count(read_3_bingeeating_OR_bingeing_OR_overeating_OR_binges) # 33


# Xaav6 = Suspected binge eating disorder
gp_clinical <- gp_clinical %>%
  mutate(read_3_suspected_BED =
           case_when(read_3 == "Xaav6" ~ 1)
  )

gp_clinical %>%
  count(read_3_suspected_BED) # 1


# E2751 = 'Compulsive eating disorder (& [bulimia including non-organic overeating])' OR 'Compulsive eating disorder' OR 'Bulimia (non-organic overeating)'
gp_clinical <- gp_clinical %>%
  mutate(read_3_compulsive_ED_OR_BN =
           case_when(read_3 == "E2751" ~ 1)
  )

gp_clinical %>%
  count(read_3_compulsive_ED_OR_BN) # 30


# XE2b9 = 'Overeating associated with other psychological disturbances'
gp_clinical <- gp_clinical %>%
  mutate(read_3_overeating_psych_disturbances =
           case_when(read_3 == "XE2b9" ~ 1)
  )

gp_clinical %>%
  count(read_3_overeating_psych_disturbances) # 3


# X00T1 = 'Atypical bulimia nervosa'
gp_clinical <- gp_clinical %>%
  mutate(read_3_atypical_BN =
           case_when(read_3 == "X00T1" ~ 1)
  )

gp_clinical %>%
  count(read_3_atypical_BN) # 4

# XE1Yk = 'Bulimia nervosa' OR 'BN - Bulimia nervosa'
gp_clinical <- gp_clinical %>%
  mutate(read_3_BN =
           case_when(read_3 == "XE1Yk" ~ 1)
  )

gp_clinical %>%
  count(read_3_BN) # 215

# Eu502 = [X] (Bulimia nervosa) or (bulimia NOS) or (hyperorexia nervosa)
gp_clinical <- gp_clinical %>%
  mutate(read_3_XBN_OR_BN_NOS_OR_hyperorexia_nervosa =
           case_when(read_3 == "Eu502" ~ 1)
  )

gp_clinical %>%
  count(read_3_XBN_OR_BN_NOS_OR_hyperorexia_nervosa) # 28
```

#### Create dataset of GP cases of binge eating
##### Broad binge eating
```{r GP create dataset of broad BE cases}
gp_BE_broad <- gp_clinical %>%
  filter(read_2_Xbulimia_nervosa_OR_bulimiaNOS == 1 |
                    read_2_bulimia_nonorganic_overeating == 1 |
                    read_3_suspected_BED == 1 |
                    read_3_BN == 1 |
                    read2_binge_eating == 1 |
                    read_2_atypical_bulimia_nervosa ==1 |
                    read_3_atypical_BN == 1 
           ) 

gp_BE_broad$GP_broad_BE <- 1

gp_BE_broad <- gp_BE_broad %>%
  select(eid, 
         GP_broad_BE)

# check no. of rows
nrow(gp_BE_broad)
# check no. of unique IDs
length(unique(gp_BE_broad$eid))

gp_BE_broad <- gp_BE_broad %>% 
  distinct(eid, .keep_all = TRUE) 

# Check that same amount of unique IDs as there are rows
gp_BE_broad %>%
  nrow()

length(unique(gp_BE_broad$eid))

# Check
gp_BE_broad %>%
  count(GP_broad_BE)
```

##### Narrow binge eating
```{r GP create dataset of narrow BE cases}
gp_BE_narrow <- gp_clinical %>%
  filter(read_2_Xbulimia_nervosa_OR_bulimiaNOS == 1 |
                    read_2_bulimia_nonorganic_overeating == 1 |
                    read_3_suspected_BED == 1 |
                    read_3_BN == 1 
           ) 

gp_BE_narrow$GP_narrow_BE <- 1

gp_BE_narrow <- gp_BE_narrow %>%
  select(eid, 
         GP_narrow_BE)

# check no. of rows
nrow(gp_BE_narrow)
# check no. of unique IDs - mismatch! need to get rid of dup IDs before merging
length(unique(gp_BE_narrow$eid))

gp_BE_narrow <- gp_BE_narrow %>% 
  distinct(eid, .keep_all = TRUE) 

# Check that same amount of unique IDs as there are rows
gp_BE_narrow %>%
  nrow()

length(unique(gp_BE_narrow$eid))

# Check
gp_BE_narrow %>%
  count(GP_narrow_BE)
```

### Merge all the GP data
```{r GP merge all data}
# Merge the datasets
GP_dat <- list(
  gp_BE_narrow, 
  gp_BE_broad,
  gp_anorexia_read3,
  gp_anorexia_nervosa_read3,
  gp_anorexia_read2,
  gp_anorexia_nervosa_read2
  ) %>% 
  reduce(full_join, 
         by = "eid"
  )

# Check
GP_dat %>%
  colnames()
```

Remove dataframes no longer needed (only need GP_dat)
```{r GP remove dataframes to save memory}
rm(gp_clinical)
rm(gp_BE_narrow)
rm(gp_BE_broad)
rm(gp_anorexia_read3)
rm(gp_anorexia_nervosa_read3)
rm(gp_anorexia_read2)
rm(gp_anorexia_nervosa_read2)
gc()
```

# Merge ALL data: MHQ, Death, HES, and GP
```{r merge ALL data}
dat <- list(
  GP_dat,
  death_data_cases,
  hesin_exclusion_dat, # incl. info on exclusion cases
  MHQ_dat_cases
  ) %>% 
  reduce(full_join, 
         by = "eid"
  )

# Check
nrow(dat)
colnames(dat)
length(unique(dat$eid))
```

Remove dataframes not needed (only need 'dat' now)
```{r remove dataframes not needed}
rm(GP_data_cases)
rm(death_data_cases)
rm(HES_data_cases)
rm(MHQ_dat_cases)
gc()
```

# "Anorexia" and exclusion criteria
CASES: "Anorexia" GP code and does NOT have HES exclusion code (incl. people without any HES data as cases), i.e., limited exclusions to people with known data on a counter indicated condition.
Those excluded: Can not be controls either (as discussed PGC analyst call 28/01/22)
```{r anorexia exclusions prevalence of exlusionary conditions}
# Consider the prevalence of exclusionary conditions and see how likely it is that someone without HES data has an exclusion we don't know about
dat %>%
  count(HES_exclusion_criteria) # 69823 meet exclusion criteria, 365710 do not (16%)

dat %>%
  count(HES_data_entry) # 68 people are missing HES data

# Therefore, most people have at least one HES data entry and 16% of people with HES data meet exclusion criteria. 
```

Create 'anorexia' variable (i.e., GP code of "anorexia")
```{r anorexia exclusions create variable}
# 'Anorexia' GP code
dat <- dat %>%
  mutate(anorexia =
           case_when(
           GP_anorexia_read3 == 1 |
           GP_anorexia_read2 == 1 ~ 1
           )
  )

# Check
dat %>%
  count(anorexia) # 519 people have 'anorexia' GP code
```

Do these people meet criteria for AN elsewhere?
```{r anorexia exclusions meeting criteria elsewhere}
# Anorexia GP and does not meet criteria for anorexia nervosa elsewhere
dat <- dat %>%
  mutate(anorexia_GP_only =
           case_when(
             anorexia == 1 &
             (
               is.na(AN_MHQ) &
               is.na(death_due_to_AN) &
               is.na(GP_anorexia_nervosa_read3) &
               is.na(GP_anorexia_nervosa_read2) &
               is.na(ICD_AN) &
               is.na(ICD10_AAN)
               ) ~ 1
           )
  )

dat %>%
  count(anorexia_GP_only) # 490 people have ONLY the anorexia GP code and do not meet criteria elsewhere
```

Do these people meet exclusion criteria?
```{r anorexia exclusions GP code only and meets exclusion criteria}
# EXCLUDE: Anorexia GP only and meets exclusion criteria
dat <- dat %>%
  mutate(anorexia_excluded =
           case_when(
             anorexia_GP_only == 1 &
             HES_exclusion_criteria == 1 ~ 1
           )
  )

dat %>%
  count(anorexia_excluded) # 127 people to exclude (GP anorexia code only and meet exclusion criteria)

# DO NOT EXCLUDE (for now): Anorexia GP only but does not meets exclusion criteria
dat <- dat %>%
  mutate(anorexia_not_excluded =
           case_when(
             anorexia_GP_only == 1 &
             (HES_exclusion_criteria != 1 |
               is.na(HES_exclusion_criteria)) ~ 1
           )
  )

dat %>%
  count(anorexia_not_excluded) # 363 people to possibly keep as cases
```

Do these people have ANY HES data entry?
```{r anorexia exclusions HES data availability}
dat %>%
  filter(anorexia_not_excluded == 1) %>%
  count(HES_data_entry) # 340 have at least one HES data entry, 23 have no HES data (Joni:  I think it’s fine for someone who has a GP diag of anorexia to be a case, in the absence of HES data for exclusion - typically wouldn’t define someone as being “definitely not” something in the absence of data (e.g. I wouldn’t assume that everyone who doesn’t have the anorexia HES code is a control), but I think its ok to limit exclusions to people with known data on a counter indicated condition.))
```

## Additional exclusion criteria: How many of these participants have type 1 diabetes? 
```{r additional exclusion criteria type 1 diabetes}
hesin_diag_diskframe <- bio_record(project_dir, record = "hesin_diag")

hesin_diag <- hesin_diag_diskframe %>%
    select(eid,
           diag_icd9,
           diag_icd10,
           ) %>%
    collect()

nrow(hesin_diag)
colnames(hesin_diag)
```

Diabetes check
```{r diabetes type 1 ICD9}
# Type 1 diabetes ICD9
hesin_diag <- hesin_diag %>%
  mutate(type1_diabetes_ICD9 =
           case_when(diag_icd9 == "25001" |  # "Diabetes mellitus without mention of complication (juvenile type)"
                     diag_icd9 == "25011"   # "Diabetes with ketoacidosis (juvenile type)"
                       ~ 1
            ))

hesin_type1_diabetes_ICD9 <- hesin_diag %>%
  filter(type1_diabetes_ICD9 == 1) 

hesin_type1_diabetes_ICD9$type1_diabetes_ICD9 <- 1

hesin_type1_diabetes_ICD9 <- hesin_type1_diabetes_ICD9 %>%
  select(eid, 
         type1_diabetes_ICD9)

# check no. of rows
nrow(hesin_type1_diabetes_ICD9)
# check no. of unique IDs - mismatch! need to get rid of dup IDs before merging
length(unique(hesin_type1_diabetes_ICD9$eid))

hesin_type1_diabetes_ICD9 <- hesin_type1_diabetes_ICD9 %>% 
  distinct(eid, .keep_all = TRUE) 
```

```{r possible diabetes type 1 ICD9}
# Possible type 1 diabetes ICD9
hesin_diag <- hesin_diag %>%
  mutate(possible_type1_diabetes_ICD9 =
           case_when(
             diag_icd9 == "25009" | # "Diabetes mellitus without mention of compl. (adult/juvenile unspec.)"
              diag_icd9 == "25019" | # "Diabetes with ketoacidosis (adult/juvenile unspec.)"
              diag_icd9 == "25099" |  # "Diabetes with unspecified complications (unspecified onset)"
               diag_icd9 == "2503" | # "Diabetes with renal manifestations"
               diag_icd9 == "2504" | # "Diabetes with ophthalmic manifestations"
               diag_icd9 == "2505"  # "Diabetes with neurological manifestations"
               ~ 1
               ))

hesin_possible_type1_diabetes_ICD9 <- hesin_diag %>%
  filter(possible_type1_diabetes_ICD9 == 1) 

hesin_possible_type1_diabetes_ICD9$possible_type1_diabetes_ICD9 <- 1

hesin_possible_type1_diabetes_ICD9 <- hesin_possible_type1_diabetes_ICD9 %>%
  select(eid, 
         possible_type1_diabetes_ICD9)

# check no. of rows
nrow(hesin_possible_type1_diabetes_ICD9)
# check no. of unique IDs - mismatch! need to get rid of dup IDs before merging
unique(hesin_possible_type1_diabetes_ICD9$eid)

hesin_possible_type1_diabetes_ICD9 <- hesin_possible_type1_diabetes_ICD9 %>% 
  distinct(eid, .keep_all = TRUE) 
```

```{r diabetes type 1 ICD10}
# Type 1 diabetes ICD10
hesin_diag <- hesin_diag %>%
  mutate(type1_diabetes_ICD10 =
          case_when( # Insulin-dependent diabetes mellitus...
                     diag_icd10 == "E100" |  # With coma
                     diag_icd10 == "E101" |   # With ketoacidosis
                     diag_icd10 == "E102" |   # With renal complications
                     diag_icd10 == "E103" |   # With ophthalmic complications
                     diag_icd10 == "E104" |   # With neurological complications
                      diag_icd10 == "E105" |   # With peripheral circulatory complications
                      diag_icd10 == "E106" |   # With other specified complications
                      diag_icd10 == "E107" |   # With multiple complications
                      diag_icd10 == "E108" |   # With unspecified complications57
                      diag_icd10 == "E109"   # Without complications
                     ~ 1
            ))

hesin_type1_diabetes_ICD10 <- hesin_diag %>%
  filter(type1_diabetes_ICD10 == 1) 

hesin_type1_diabetes_ICD10$type1_diabetes_ICD10 <- 1

hesin_type1_diabetes_ICD10 <- hesin_type1_diabetes_ICD10 %>%
  select(eid, 
         type1_diabetes_ICD10)

# check no. of rows
nrow(hesin_type1_diabetes_ICD10)
# check no. of unique IDs - mismatch! need to get rid of dup IDs before merging
length(unique(hesin_type1_diabetes_ICD10$eid))

hesin_type1_diabetes_ICD10 <- hesin_type1_diabetes_ICD10 %>% 
  distinct(eid, .keep_all = TRUE) 

nrow(hesin_type1_diabetes_ICD10)
```

```{r possible diabetes type 1 ICD10}
# Possible type 1 diabetes ICD10
hesin_diag <- hesin_diag %>%
  mutate(possible_type1_diabetes_ICD10 =
           case_when(
             # Malnutrition-related diabetes mellitus...
               diag_icd10 == "E121" | # With ketoacidosis
               diag_icd10 == "E123" | # With ophthalmic complications
               diag_icd10 == "E125" | # With peripheral circulatory complications
               diag_icd10 == "E128"  | # With unspecified complications
               diag_icd10 == "E129"  | # Without complications
             
              # Other specified diabetes mellitus
                diag_icd10 == "E130" | # With ketoacidosis
                diag_icd10 == "E131" | # With ophthalmic complications
                diag_icd10 == "E132" | # With peripheral circulatory complications
                diag_icd10 == "E133"  | # With unspecified complications
                diag_icd10 == "E134"  | # Without complications
                diag_icd10 == "E135"  | # With peripheral circulatory complications
                diag_icd10 == "E136"  | # With other specified complications
                diag_icd10 == "E137"  | # With multiple complications
                diag_icd10 == "E138"  | # With unspecified complications 
                diag_icd10 == "E139" | # Without complications
                
               # Unspecified diabetes mellitus 
                diag_icd10 == "E140" | # With ketoacidosis
                diag_icd10 == "E141" | # With ophthalmic complications
                diag_icd10 == "E142" | # With peripheral circulatory complications
                diag_icd10 == "E143"  | # With unspecified complications
                diag_icd10 == "E144"  | # Without complications
                diag_icd10 == "E145"  | # With peripheral circulatory complications
                diag_icd10 == "E146"  | # With other specified complications
                diag_icd10 == "E147"  | # With multiple complications
                diag_icd10 == "E148"  | # With unspecified complications 
                diag_icd10 == "E149"  # Without complications
                ~ 1
               ))


hesin_possible_type1_diabetes_ICD10 <- hesin_diag %>%
  filter(possible_type1_diabetes_ICD10 == 1) 

hesin_possible_type1_diabetes_ICD10$possible_type1_diabetes_ICD10 <- 1

hesin_possible_type1_diabetes_ICD10 <- hesin_possible_type1_diabetes_ICD10 %>%
  select(eid, 
         possible_type1_diabetes_ICD10)

# check no. of rows
nrow(hesin_possible_type1_diabetes_ICD10)
# check no. of unique IDs - mismatch! need to get rid of dup IDs before merging
length(unique(hesin_possible_type1_diabetes_ICD10$eid))

hesin_possible_type1_diabetes_ICD10 <- hesin_possible_type1_diabetes_ICD10 %>% 
  distinct(eid, .keep_all = TRUE) 
```

Merge all diabetes datasets by ID
```{r diabetes dat merge all datasets}
diabetes_dat <- list(
  hesin_type1_diabetes_ICD9,
  hesin_possible_type1_diabetes_ICD9,
  hesin_type1_diabetes_ICD10,
  hesin_possible_type1_diabetes_ICD10
  ) %>% 
  reduce(full_join, 
         by = "eid"
  )

# Check
nrow(diabetes_dat)
colnames(diabetes_dat)
```

Drop unneeded datasets
```{r remove dataframes to save memory}
rm(hesin_type1_diabetes_ICD9)
rm(hesin_possible_type1_diabetes_ICD9)
rm(hesin_type1_diabetes_ICD10)
rm(hesin_possible_type1_diabetes_ICD10)
gc()
```

### Merge diabetes data with data
```{r merge diabetes data with data}
dat2 <- list(
  diabetes_dat,
  dat
  ) %>% 
  reduce(full_join, 
         by = "eid"
  )

# Check
nrow(dat2)
colnames(dat2)
```

### Identify those of the 363 with diabetes
```{r identify remaining anorexia cases with diabetes}
dat2 <- dat2 %>%
  mutate(anorexia_not_excluded_diabetes =
           case_when(
             anorexia_not_excluded == 1 &
             (type1_diabetes_ICD9 == 1 |
                type1_diabetes_ICD10 == 1) ~ 1
           )
  )

dat2 %>%
  count(anorexia_not_excluded_diabetes) # 7 definitely have type 1 diabetes

dat2 <- dat2 %>%
  mutate(anorexia_not_excluded_possible_diabetes =
           case_when(
             anorexia_not_excluded == 1 &
             (type1_diabetes_ICD9 == 1 |
              type1_diabetes_ICD10 == 1 |
              possible_type1_diabetes_ICD9 == 1 |
              possible_type1_diabetes_ICD10 == 1) ~ 1
           )
  )

dat2 %>%
  count(anorexia_not_excluded_possible_diabetes) # an additional 6 possibly also have type 1 diabetes

## Need to exclude these people - will use in PRS
```

# PGC numbers
## Anorexia nervosa cases
```{r PGC numbers anorexia nervosa overall cases}
# MHQ case
dat2 %>%
  count(AN_MHQ) # 891

# GP case: Anorexia nervosa
dat2 <- dat2 %>%
  mutate(GP_anorexia_nervosa_case =
           case_when(   
                      # GP data
                    GP_anorexia_nervosa_read3 == 1 |
                    GP_anorexia_nervosa_read2 == 1 ~ 1,
                      
                   TRUE ~ 0 # Not AN case
                     )
         )

# Check
dat2 %>%
  count(GP_anorexia_nervosa_case) # 301

# GP case: Anorexia but does not meet excl criteria (incl. diabetes)
dat2 <- dat2 %>%
  mutate(GP_anorexia_case =
           case_when(   
                      # GP data
                    anorexia_not_excluded == 1 & # GP code of anorexia, does not meet AN criteria elsewhere, and does not meet original excl. criteria...
                    is.na(anorexia_not_excluded_possible_diabetes) ~ 1, # ..and does not meet criteria for diabetes
                      
                   TRUE ~ 0 # Not AN case
                     )
         )

# Check
dat2 %>%
  count(GP_anorexia_case) # 350 people left over (i.e., excluded 13 people of the 363 due to diabetes and thus possibly diabulimia)


# HES case
dat2 <- dat2 %>%
  mutate(HES_AN_case =
           case_when(   
                       # HES data
                      ICD_AN == 1 | # ICD-10 code of F500 (Anorexia nervosa) or ICD-9 code of 3071 (Anorexia nervosa) 
                      ICD10_AAN == 1 ~ 1, # or ICD-10 code of F501 (atypical Anorexia nervosa)
                      
                   TRUE ~ 0 # Not AN case
                     )
         )

# Check
dat2 %>%
  count(HES_AN_case) # 90

# Overall AN cases
dat2 <- dat2 %>%
  mutate(AN_case =
           case_when( # MHQ data
                      AN_MHQ == 1 | 
                        
                      # GP data
                    GP_anorexia_nervosa_case == 1 |
                    GP_anorexia_case == 1 |
                      
                      # Death data
                      death_due_to_AN == 1 |
                      
                      # HES data
                      HES_AN_case  ~ 1,
                   
                   TRUE ~ 0 # Not AN case
                     )
         )

# Check
dat2 %>%
  count(AN_case) # 1512
```

Explore where AN cases were identified
```{r PGC numbers anorexia nervosa origin case identification}
table <- dat2 %>%
  filter(AN_case == 1) %>%
  group_by(GP_anorexia_nervosa_case,
           GP_anorexia_case,
           death_due_to_AN,
           AN_MHQ,
           HES_AN_case) %>%
  count()

# Double check how many are GP only
GP_cases <- dat2 %>% 
  filter(
       (
         (GP_anorexia_nervosa_case == 1 |
           GP_anorexia_case == 1) &
          
          ((death_due_to_AN == 0 |
          is.na(death_due_to_AN)) &
           (AN_MHQ == 0 |
          is.na(AN_MHQ)) &
           (HES_AN_case ==0 |
              is.na(HES_AN_case)))
           ) 
  )

nrow(GP_cases)

GP_cases %>%
  group_by(GP_anorexia_nervosa_case,
           GP_anorexia_case) %>%
  count()

GP_cases %>%
  group_by(GP_anorexia_nervosa_case,
           GP_anorexia_case) %>%
  count()
```


## BE narrow cases
Narrowly defined binge eating: All individuals who meet any of the following criteria will be coded as “BE_narrow = 1”:
       
1. Eating an unusually large amount of food in an unusually short period of time with loss of control when doing so, and these episodes occurred on average at least once a week for at least three months (= DSM-5 frequency and duration criteria);
      
2. Has received a clinical diagnosis of BN or BED via hospital or register records or a structured clinical interview;
             a. If ANBP or OSFED/EDNOS is diagnosed, these individuals will only be included if symptom-level data confirm that they endorse the symptoms as described in item 1 of narrowly defined binge eating);
   
3. Has a self-reported diagnosis of BN or BED, with specification that this has been confirmed by a healthcare professional; If ANBP or OSFED/EDNOS is diagnosed, these individuals will only be included if symptom-level confirms that they endorse the symptoms as described in item 1 of narrowly defined binge eating).
```{r PGC numbers BE narrow overall cases}
dat2 <- dat2 %>%
  mutate(BE_narrow =
           case_when( # MHQ data
                      BN_MHQ == 1 | 
                        
                      # GP data
                      GP_narrow_BE == 1 |

                      # HES data
                      ICD10_BN == 1 ~ 1
                     )
         )

dat2 %>%
  count(BE_narrow) # 664
```

Explore where narrow BE cases were identified
```{r PGC numbers BE narrow origin case identification}
dat2 %>%
  filter(BE_narrow == 1) %>%
  group_by(BN_MHQ,
           GP_narrow_BE,
           ICD10_BN) %>%
  count()
```

# BE broad cases
Broadly defined binge eating: All individuals who meet any of the following criteria will be coded as “BE_broad = 1”:
1. Eating an unusually large amount of food in an unusually short period of time with loss of control when doing so. Frequency and duration criteria are not required.
     
2. If binge eating (BE) is assessed in a single question like: “Have you ever experienced binge eating?” and is endorsed, they will be considered to have BE and be included in the primary BE GWAS. If the question combines several descriptors such as “Have you ever experienced binge eating OR other terms like psychological overeating, compulsive eating, emotional eating, etc.”), it should not be used for the primary BE GWAS but can be used for PRS analyses.
    
3. Has a self-reported diagnosis of BN or BED (specification that this has been confirmed by a healthcare professional is not required for this definition);
           a. If ANBP or OSFED/EDNOS is diagnosed, these individuals will only be included if they explicitly state ‘subthreshold BN’ or ‘subthreshold BED’.
```{r PGC numbers BE broad overall cases}
dat2 <- dat2 %>%
  mutate(BE_broad =
           case_when( 
                   BE_narrow == 1 |
             
                    # MHQ data
                    BN_MHQ == 1 | 
                    
                   # GP data
                    GP_broad_BE == 1 |
                      
                    # HES data
                    ICD10_BN == 1 |
                    ICD10_ABN == 1  # NB: No one is classed as atypical bulimia 
                   ~ 1
                     )
         )


dat2 %>%
  count(BE_broad) # 674
```

Explore where broad BE cases were identified
```{r PGC numbers BE broad origin case identification}
dat2 %>%
  filter(BE_broad == 1) %>%
  group_by(BN_MHQ,
           GP_broad_BE,
           GP_narrow_BE,
           ICD10_BN) %>%
  count()
```

Explore how many AN cases have broad BE 
```{r PGC numbers AN cases comorbid BE}
dat2 %>%
  group_by(BE_broad,
           AN_case) %>%
  count()

dat2 %>%
  group_by(BE_narrow,
           AN_case) %>%
  count()
```

# Save final dataset
First, all variables
```{r save data all variables}
all_variables_case_dat <- dat2 %>%
  select(eid,
       
         # Cleaned analysis variables
         BE_narrow,
         BE_broad,
         AN_case,
         
         # BE variables
           BN_MHQ,
           GP_broad_BE,
           GP_narrow_BE,
           ICD10_BN,
         
         # AN variables
           GP_anorexia_nervosa_case,
           GP_anorexia_case,
           death_due_to_AN,
           AN_MHQ,
           HES_AN_case)

saveRDS(object = all_variables_case_dat, file = paste0("/scratch/groups/ukbiobank/usr/helena_d/UKB_PGCED3_case_data.rds"))
```

Second, only cleaned variables necessary for analysis
```{r save data cleaned analysis variables only}
only_case_dat <- dat2 %>%
  select(eid,
         BE_narrow,
         BE_broad,
         AN_case)

saveRDS(object = only_case_dat, file = paste0("/scratch/groups/ukbiobank/usr/helena_d/UKB_PGCED3_case_only_data.rds"))
```

# Covariates - available in UKB:
• Age (i.e., when assessed);
• Sex (biological sex at birth);
• Current BMI (at time of assessment)

Don't think UKB has:
• Age at onset;
• Controls: Minimum adult BMI;
• Cases: Minimum lifetime eating disorder-related body mass index (BMI);
• Maximum lifetime BMI;

You need a file with required fields, one per line, no header.
```{r COVARIATES read in data}
# Point to the project directory
project_dir <- "/scratch/datasets/ukbiobank/ukb18177"

# Read the project field-to-name “field finder” file
f <- ukbkings::bio_field(project_dir)

# inspect the variable metadata
head(f)
glimpse(f)

# display the number of baskets included.
f %>%
distinct(basket)
```

Search for variables required 
```{r COVARIATES search for required variables}
f %>%
select(name, field) %>%
page(method = "print")
```

Add their field codes to a file, one per line, no header. You can page through the file.
```{r COVARIATES add field code to file}
strings <- c("eid",
             "31", # sex
             "21022", # age at recruitment
             "21001" # BMI (0 = Initial assessment visit)
             ) 

f %>%
select(field, name) %>%
filter(str_detect(field,
                  paste(strings, collapse = "|"))) %>%
  bio_field_add("small_field_subset.txt")
```

Read required fields and save as an rds file in your user directory. Argument out should be a path to your UKB user directory
```{r COVARIATES save required fields as rds}
bio_phen(
 project_dir,
 field = "small_field_subset.txt",
 out = "small_phenotype_subset"
)
```

Check the size of your file and read in your dataset
```{r COVARIATES read in datasest}
system("ls -lh small_phenotype_subset.rds")
df <- readRDS("small_phenotype_subset.rds")
```

Rename columns from the default UKB field names to the descriptive names used in the field-to-name “field finder” name column.
```{r COVARIATES rename columns using bio_rename}
df <- bio_rename(df, f)
nrow(df)
```

Check col names - select relevant ones
```{r COVARIATES select relevant columns}
colnames(df)

covariates <- df %>%
  select(eid,
         sex = sex_f31_0_0, # Sex
         bmi_at_initial_recruitment = `body_mass_index_(bmi)_f21001_0_0`, # BMI at initial recruitment
         age_at_recruitment = age_at_recruitment_f21022_0_0 # age at recruitment
         )
```

## Save covariate data
```{r save covariate data}
saveRDS(object = covariates, file = paste0("/scratch/groups/ukbiobank/usr/helena_d/UKB_PGCED3_covariates.rds"))
```

